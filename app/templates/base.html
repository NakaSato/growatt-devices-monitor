<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no"
    />
    <meta
      name="description"
      content="Growatt API - Monitor your solar energy production and devices"
    />
    <meta
      name="keywords"
      content="Growatt, solar energy, monitoring, API, renewable energy"
    />
    <meta name="author" content="Growatt API" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="{{ request.url }}" />
    <meta name="theme-color" content="#ffffff" />

    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" />

    <!-- Google Fonts - Noto Sans Thai -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap"
      rel="stylesheet"
    />

    <!-- Alpine.js Plugins -->
    <script
      defer
      src="https://unpkg.com/@alpinejs/intersect@3.x.x/dist/cdn.min.js"
    ></script>
    <script
      defer
      src="https://unpkg.com/@alpinejs/persist@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- Alpine.js Core -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- Component Loader -->
    <script src="{{ url_for('static', filename='js/component-loader.js') }}"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
      tailwind.config = {
        theme: {
          screens: {
            xs: "320px",
            sm: "640px",
            md: "768px",
            lg: "1024px",
            xl: "1280px",
            "2xl": "1536px",
          },
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
            },
            fontFamily: {
              sans: ['"Noto Sans Thai"', "sans-serif"],
            },
            spacing: {
              72: "18rem",
              84: "21rem",
              96: "24rem",
            },
            maxWidth: {
              "1/4": "25%",
              "1/2": "50%",
              "3/4": "75%",
              xs: "20rem",
            },
            minHeight: {
              "screen-75": "75vh",
              "screen-50": "50vh",
            },
          },
        },
        variants: {
          extend: {
            display: ["responsive", "hover", "focus", "group-hover"],
            opacity: ["responsive", "hover", "focus", "group-hover"],
            scale: ["responsive", "hover", "focus", "active"],
          },
        },
      };
    </script>

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />

    <title>
      {% block title %}Growatt API - Solar Monitoring System{% endblock %}
    </title>
    <!-- Open Graph tags for social media sharing -->
    <meta property="og:title" content="Growatt API - Solar Monitoring System" />
    <meta
      property="og:description"
      content="Monitor and analyze your Growatt solar energy production and devices"
    />
    <meta property="og:url" content="{{ request.url }}" />
    <meta property="og:type" content="website" />

    <!-- Page-specific styles -->
    {% block styles %}{% endblock %}

    <!-- Custom JavaScript block -->
    {% block head_scripts %}{% endblock %}

    <!-- Component Registration -->
    <script>
      document.addEventListener("alpine:init", () => {
        // Register global components
        Alpine.data("componentRegistry", () => ({
          components: {},

          registerComponent(name, callback) {
            this.components[name] = callback;
            return this;
          },

          getComponent(name) {
            return this.components[name] || (() => ({}));
          },
        }));

        // Add useful directives
        Alpine.directive("lazy-load", (el, { expression }, { evaluate }) => {
          const src = evaluate(expression);
          const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                if (el.tagName === "IMG") {
                  el.src = src;
                } else {
                  el.style.backgroundImage = `url(${src})`;
                }
                observer.disconnect();
              }
            });
          });
          observer.observe(el);
        });
      });
    </script>

    {% if config.get('LIVE_RELOAD_ENABLED', False) %}
    <!-- Live Reload Script for Development -->
    <script>
      (function () {
        // Check for file changes every 1000ms
        const checkInterval = 1000;
        let lastModified = {};

        // Files to monitor (add more as needed)
        const filesToMonitor = [
          '{{ url_for("static", filename="css/style.css") }}',
          // Add more static files here as needed
        ];

        function checkForChanges() {
          filesToMonitor.forEach((file) => {
            // Add cache-busting parameter to prevent browser caching
            const url = file + "?check=" + new Date().getTime();

            fetch(url, { method: "HEAD" })
              .then((response) => {
                const modified = response.headers.get("Last-Modified");
                if (lastModified[file] && lastModified[file] !== modified) {
                  console.log(`File changed: ${file}, reloading...`);
                  window.location.reload();
                }
                lastModified[file] = modified;
              })
              .catch((err) => console.error("Error checking file:", err));
          });
        }

        // Initialize by getting current timestamps
        filesToMonitor.forEach((file) => {
          fetch(file + "?init=" + new Date().getTime(), { method: "HEAD" })
            .then((response) => {
              lastModified[file] = response.headers.get("Last-Modified");
            })
            .catch((err) =>
              console.error("Error initializing file check:", err)
            );
        });

        // Start periodic checking
        setInterval(checkForChanges, checkInterval);

        console.log("Live reload for static files enabled");
      })();
    </script>
    {% endif %}
  </head>

  <body class="min-h-screen">
    <!-- Header and Navigation -->
    {% include 'components/navbar.html' %}

    <main class="container mx-auto min-h-screen">
      {% block content %}{% endblock %}
    </main>

    {% include 'components/footer.html' %}

    <!-- Custom JavaScript at end of body -->
    {% block scripts %}{% endblock %}

    <script>
      // Function to handle API access with improved error handling and user feedback
      document.addEventListener("DOMContentLoaded", () => {
        const apiAccessLink = document.getElementById("api-access-link");
        if (apiAccessLink) {
          apiAccessLink.addEventListener("click", requestApiAccess);
        }

        // Initialize component loader
        if (window.ComponentLoader) {
          window.componentLoader = new ComponentLoader({
            templatePath: "/templates/components/",
            cacheDuration: 3600, // 1 hour cache
            onError: (err) => console.error("Component loading error:", err),
          });
        }
      });

      function requestApiAccess(event) {
        if (event) {
          event.preventDefault();
        }

        // Show loading state to user
        const originalLinkText = event.target.textContent;
        event.target.textContent = "Loading...";
        event.target.classList.add("opacity-50");

        fetch("/api/access", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          credentials: "same-origin",
        })
          .then((response) => {
            // Check if the content-type is JSON
            const contentType = response.headers.get("content-type");

            if (!response.ok) {
              if (contentType && contentType.includes("text/html")) {
                window.location.href = response.url;
                throw new Error("Session expired. Redirecting to login...");
              }
              throw new Error(`Request failed with status ${response.status}`);
            }

            // Check if response is JSON before trying to parse it
            if (contentType && contentType.includes("application/json")) {
              return response.json();
            } else {
              // Handle redirect instruction from JSON response
              return { status: "redirect", url: "/plants" };
            }
          })
          .then((data) => {
            if (data.status === "success") {
              // Show success message before redirect
              console.log("Authentication successful");
              setTimeout(() => (window.location.href = "/plants"), 800);
            } else if (data.status === "redirect") {
              window.location.href = data.url || "/plants";
            } else {
              throw new Error(data.message || "Failed to authenticate");
            }
          })
          .catch((error) => {
            console.error("API access error:", error);
            // Only show alert for errors that aren't redirects
            if (!error.message.includes("Redirecting to login")) {
              alert("Failed to access API: " + error.message);
            }
          })
          .finally(() => {
            // Reset button state
            event.target.textContent = originalLinkText;
            event.target.classList.remove("opacity-50");
          });
      }

      // Function to clear cache and session before logout
      function clearCacheAndLogout() {
        // Clear browser cache and storage
        localStorage.clear();
        sessionStorage.clear();

        // Clear cookies by setting expiration to past date
        document.cookie.split(";").forEach(function (c) {
          document.cookie = c
            .replace(/^ +/, "")
            .replace(
              /=.*/,
              "=;expires=" + new Date().toUTCString() + ";path=/"
            );
        });

        // Attempt to clear application cache if supported
        if (window.caches) {
          caches.keys().then(function (names) {
            for (let name of names) caches.delete(name);
          });
        }

        // Finally redirect to logout URL
        window.location.href = "/api/logout";
      }

      // Add responsive screen detection
      window.isSmallScreen = window.matchMedia("(max-width: 640px)").matches;
      window.isMediumScreen = window.matchMedia(
        "(min-width: 641px) and (max-width: 1024px)"
      ).matches;
      window.isLargeScreen = window.matchMedia("(min-width: 1025px)").matches;

      // Update on resize
      window.addEventListener("resize", () => {
        window.isSmallScreen = window.matchMedia("(max-width: 640px)").matches;
        window.isMediumScreen = window.matchMedia(
          "(min-width: 641px) and (max-width: 1024px)"
        ).matches;
        window.isLargeScreen = window.matchMedia("(min-width: 1025px)").matches;
      });
    </script>
  </body>
</html>
