<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Growatt API - Monitor your solar energy production and devices"
    />
    <meta
      name="keywords"
      content="Growatt, solar energy, monitoring, API, renewable energy"
    />
    <meta name="author" content="Growatt API" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="{{ request.url }}" />

    <!-- Google Fonts - Noto Sans Thai -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap"
      rel="stylesheet"
    />

    <!-- Alpine.js -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />

    <title>
      {% block title %}Growatt API - Solar Monitoring System{% endblock %}
    </title>
    <!-- Open Graph tags for social media sharing -->
    <meta property="og:title" content="Growatt API - Solar Monitoring System" />
    <meta
      property="og:description"
      content="Monitor and analyze your Growatt solar energy production and devices"
    />
    <meta property="og:url" content="{{ request.url }}" />
    <meta property="og:type" content="website" />
    <!-- Custom JavaScript block -->
    {% block head_scripts %}{% endblock %}
  </head>

  <body class="min-h-screen flex flex-col" x-data="{}">
    <!-- Header and Navigation -->
    {% include 'navbar.html' %}

    <main class="container mx-auto flex-grow px-4">
      {% block content %}{% endblock %}
    </main>

    <footer class="text-white text-center p-4 mt-8">
      <p>&copy; 2023 Growatt API. All rights reserved.</p>
    </footer>

    <!-- Custom JavaScript at end of body -->
    {% block scripts %}{% endblock %}

    <script>
      // Function to handle API access with improved error handling and user feedback
      document.addEventListener("DOMContentLoaded", () => {
        const apiAccessLink = document.getElementById("api-access-link");
        if (apiAccessLink) {
          apiAccessLink.addEventListener("click", requestApiAccess);
        }
      });

      function requestApiAccess(event) {
        if (event) {
          event.preventDefault();
        }

        // Show loading state to user
        const originalLinkText = event.target.textContent;
        event.target.textContent = "Loading...";
        event.target.classList.add("opacity-50");

        fetch("/api/access", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          credentials: "same-origin",
        })
          .then((response) => {
            // Check if the content-type is JSON
            const contentType = response.headers.get("content-type");

            if (!response.ok) {
              if (contentType && contentType.includes("text/html")) {
                window.location.href = response.url;
                throw new Error("Session expired. Redirecting to login...");
              }
              throw new Error(`Request failed with status ${response.status}`);
            }

            // Check if response is JSON before trying to parse it
            if (contentType && contentType.includes("application/json")) {
              return response.json();
            } else {
              // Handle redirect instruction from JSON response
              return { status: "redirect", url: "/plants" };
            }
          })
          .then((data) => {
            if (data.status === "success") {
              // Show success message before redirect
              console.log("Authentication successful");
              setTimeout(() => (window.location.href = "/plants"), 800);
            } else if (data.status === "redirect") {
              window.location.href = data.url || "/plants";
            } else {
              throw new Error(data.message || "Failed to authenticate");
            }
          })
          .catch((error) => {
            console.error("API access error:", error);
            // Only show alert for errors that aren't redirects
            if (!error.message.includes("Redirecting to login")) {
              alert("Failed to access API: " + error.message);
            }
          })
          .finally(() => {
            // Reset button state
            event.target.textContent = originalLinkText;
            event.target.classList.remove("opacity-50");
          });
      }

      // Function to clear cache and session before logout
      function clearCacheAndLogout() {
        // Clear browser cache and storage
        localStorage.clear();
        sessionStorage.clear();

        // Clear cookies by setting expiration to past date
        document.cookie.split(";").forEach(function (c) {
          document.cookie = c
            .replace(/^ +/, "")
            .replace(
              /=.*/,
              "=;expires=" + new Date().toUTCString() + ";path=/"
            );
        });

        // Attempt to clear application cache if supported
        if (window.caches) {
          caches.keys().then(function (names) {
            for (let name of names) caches.delete(name);
          });
        }

        // Finally redirect to logout URL
        window.location.href = "/api/logout";
      }

      // Make functions available to Alpine.js
      document.addEventListener("alpine:init", () => {
        Alpine.data("app", () => ({
          clearCacheAndLogout() {
            clearCacheAndLogout();
          },
        }));
      });
    </script>
  </body>
</html>
