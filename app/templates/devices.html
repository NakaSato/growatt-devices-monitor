{% extends "base.html" %} 
{% block title %}Devices - Growatt API{% endblock %}
{% block content %}
<div class="container mx-auto px-3 sm:px-4 md:px-6 py-3 sm:py-6 max-w-7xl">
  <div class="bg-gradient-mint rounded-xl shadow-md p-4 sm:p-6">
    <div
      class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3"
    >
      <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-deep-forest font-headings">
        Device Status
      </h1>
      <div class="flex flex-wrap gap-2">
        <button
          id="refresh-btn"
          class="btn-primary flex items-center gap-2 text-sm sm:text-base px-3 py-1.5 rounded transition-all duration-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
          <span>Refresh</span>
        </button>
        <button
          id="export-btn"
          class="btn-secondary flex items-center gap-2 text-sm sm:text-base px-3 py-1.5 rounded transition-all duration-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
            />
          </svg>
          <span>Export</span>
        </button>
      </div>
    </div>

    <div id="loading" class="flex justify-center py-8 hidden">
      <div class="spinner border-4 border-t-4 border-light-gray border-t-eco-green rounded-full w-10 h-10 animate-spin"></div>
    </div>

    <div
      id="error-message"
      class="bg-red-50 text-danger p-4 mb-6 rounded-lg shadow-sm border border-danger border-opacity-20 hidden"
    >
      <div class="flex items-center">
        <svg
          class="h-5 w-5 mr-2 flex-shrink-0 text-danger"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd"
          ></path>
        </svg>
        <span id="error-text" class="text-sm sm:text-base"></span>
      </div>
      <button
        id="dismiss-error"
        class="text-sm text-danger hover:text-danger mt-2 ml-7 focus:outline-none focus:underline"
      >
        Dismiss
      </button>
    </div>

    <div id="filters-section" class="mb-6 bg-snow-white p-4 sm:p-5 rounded-lg shadow-sm border border-light-gray">
      <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:gap-4">
        <div class="flex flex-grow items-center">
          <label
            for="status-filter"
            class="text-sm font-medium text-charcoal mr-3 whitespace-nowrap"
          >Status:</label>
          <select
            id="status-filter"
            class="flex-grow form-control text-sm rounded-md border-light-gray focus:border-fresh-mint"
          >
            <option value="all">All Statuses</option>
            <option value="online">Online</option>
            <option value="offline">Offline</option>
            <option value="waiting">Waiting</option>
          </select>
        </div>
        <div class="flex flex-grow items-center">
          <label
            for="search-input"
            class="text-sm font-medium text-charcoal mr-3 whitespace-nowrap"
          >Search:</label>
          <div class="relative flex-grow">
            <input
              type="text"
              id="search-input"
              placeholder="Search devices..."
              class="w-full form-control text-sm rounded-md pr-8 border-light-gray focus:border-fresh-mint"
            />
            <svg 
              xmlns="http://www.w3.org/2000/svg" 
              class="h-4 w-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-gray" 
              fill="none" 
              viewBox="0 0 24 24" 
              stroke="currentColor"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-snow-white rounded-lg shadow-md overflow-hidden border border-light-gray">
      <div class="table-responsive overflow-x-auto">
        <table class="w-full" data-sort-order="asc">
          <thead class="bg-eco-green">
            <tr>
              <th
                onclick="sortTable(0)"
                class="px-4 py-3 text-left text-xs sm:text-sm font-medium text-snow-white uppercase tracking-wider cursor-pointer hover:bg-deep-forest transition-colors"
              >
                Plant Name <span class="sort-icon">▲</span>
              </th>
              <th
                onclick="sortTable(1)"
                class="px-4 py-3 text-left text-xs sm:text-sm font-medium text-snow-white uppercase tracking-wider cursor-pointer hover:bg-deep-forest transition-colors"
              >
                Device Alias <span class="sort-icon">▲</span>
              </th>
              <th
                onclick="sortTable(2)"
                class="px-4 py-3 text-left text-xs sm:text-sm font-medium text-snow-white uppercase tracking-wider cursor-pointer hover:bg-deep-forest transition-colors"
              >
                Serial Number <span class="sort-icon">▲</span>
              </th>
              <th
                onclick="sortTable(3)"
                class="px-4 py-3 text-left text-xs sm:text-sm font-medium text-snow-white uppercase tracking-wider cursor-pointer hover:bg-deep-forest transition-colors"
              >
                Status <span class="sort-icon">▲</span>
              </th>
              <th
                onclick="sortTable(4)"
                class="px-4 py-3 text-left text-xs sm:text-sm font-medium text-snow-white uppercase tracking-wider cursor-pointer hover:bg-deep-forest transition-colors"
              >
                Total Energy <span class="sort-icon">▲</span>
              </th>
              <th
                onclick="sortTable(5)"
                class="px-4 py-3 text-left text-xs sm:text-sm font-medium text-snow-white uppercase tracking-wider cursor-pointer hover:bg-deep-forest transition-colors"
              >
                Last Update <span class="sort-icon">▲</span>
              </th>
            </tr>
          </thead>
          <tbody>
            <!-- Data will be dynamically inserted here -->
          </tbody>
        </table>
      </div>
      <div id="no-devices" class="p-8 text-center bg-snow-white hidden">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-12 w-12 mx-auto text-slate-gray mb-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
          />
        </svg>
        <h3 class="text-lg font-medium text-deep-forest mb-2 font-headings">No Devices Found</h3>
        <p class="text-slate-gray max-w-sm mx-auto">
          No devices match the current filter criteria or no devices are available
          for this account.
        </p>
      </div>
    </div>
  </div>
</div>

<style>
  /* Animation for the loading spinner */
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }

  /* Mobile optimizations */
  @media (max-width: 640px) {
    th,
    td {
      padding-left: 0.5rem !important;
      padding-right: 0.5rem !important;
      font-size: 0.75rem !important;
    }

    /* Hide sort icons on mobile */
    .sort-icon {
      display: none;
    }

    /* Stack the device cells on small screens for better readability */
    .device-cell {
      display: flex;
      flex-direction: column;
    }

    /* Add spacing between device fields */
    .device-cell > span:not(:last-child) {
      margin-bottom: 0.25rem;
    }
  }

  /* Improve scroll experience */
  .table-responsive {
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
  }

  .table-responsive::-webkit-scrollbar {
    height: 6px;
  }

  .table-responsive::-webkit-scrollbar-thumb {
    background-color: var(--light-gray);
    border-radius: 3px;
  }
  
  .table-responsive::-webkit-scrollbar-thumb:hover {
    background-color: var(--slate-gray);
  }

  /* Status indicator styles */
  .status-indicator {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .status-online {
    background-color: rgba(76, 175, 80, 0.1);
    color: var(--eco-green);
    border: 1px solid rgba(76, 175, 80, 0.2);
  }

  .status-offline {
    background-color: rgba(244, 67, 54, 0.1);
    color: var(--danger);
    border: 1px solid rgba(244, 67, 54, 0.2);
  }

  .status-waiting {
    background-color: rgba(255, 214, 0, 0.1);
    color: var(--sunshine-yellow);
    border: 1px solid rgba(255, 214, 0, 0.2);
  }
  
  /* Table row styling */
  tbody tr {
    transition: all 0.2s ease;
  }
  
  tbody tr:hover {
    background-color: var(--eco-green-10) !important;
  }
  
  /* Table alternating rows */
  tbody tr:nth-child(even) {
    background-color: rgba(207, 216, 220, 0.1);
  }
  
  /* Sorting indicators */
  th {
    position: relative;
  }
  
  th .sort-icon {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
  }
  
  /* Energy value highlighting */
  .energy-value {
    font-weight: 500;
    color: var(--eco-green);
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const plantId = "{{ plant_id }}";
    fetchDevices();

    // Setup event listeners
    document
      .getElementById("refresh-btn")
      .addEventListener("click", fetchDevices);
    document
      .getElementById("export-btn")
      .addEventListener("click", exportToCSV);
    document
      .getElementById("dismiss-error")
      .addEventListener("click", dismissError);
    document
      .getElementById("status-filter")
      .addEventListener("change", applyFilters);
    document
      .getElementById("search-input")
      .addEventListener("input", applyFilters);

    // Use debounce for search input to prevent excessive filtering
    let searchTimeout;
    const searchInput = document.getElementById("search-input");
    searchInput.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(applyFilters, 300);
    });

    function fetchDevices() {
      // Show loading spinner
      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("no-devices").classList.add("hidden");
      
      // Add loading animation to refresh button
      const refreshBtn = document.getElementById("refresh-btn");
      const refreshIcon = refreshBtn.querySelector("svg");
      refreshIcon.classList.add("animate-spin");
      refreshBtn.disabled = true;

      // Fetch the data
      fetch(`/api/devices${plantId ? "?plant_id=" + plantId : ""}`)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          renderDevicesTable(data);
        })
        .catch((error) => {
          showError(`Failed to load devices: ${error.message}`);
          console.error("Error fetching devices:", error);
        })
        .finally(() => {
          document.getElementById("loading").classList.add("hidden");
          refreshIcon.classList.remove("animate-spin");
          refreshBtn.disabled = false;
        });
    }

    function renderDevicesTable(devices) {
      const tableBody = document.querySelector("table tbody");
      tableBody.innerHTML = "";

      if (!devices || devices.length === 0) {
        document.getElementById("no-devices").classList.remove("hidden");
        return;
      }

      // Populate the table
      devices.forEach((device) => {
        const row = document.createElement("tr");
        row.className =
          "border-b border-light-gray hover:bg-eco-green-10 transition-colors";
        row.setAttribute("data-status", device.status.toLowerCase());

        // Create status indicator class based on device status
        let statusClass = "status-waiting";
        if (device.status.toLowerCase() === "online") {
          statusClass = "status-online";
        } else if (device.status.toLowerCase() === "offline") {
          statusClass = "status-offline";
        }

        // Format the last update time
        const lastUpdateDate = device.last_update_time
          ? new Date(device.last_update_time)
          : null;
        const formattedDate = lastUpdateDate
          ? lastUpdateDate.toLocaleDateString() +
            " " +
            lastUpdateDate.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            })
          : "N/A";
          
        // Format energy value
        const energyValue = device.total_energy || "0 kWh";

        // Build the row
        row.innerHTML = `
          <td class="px-4 py-3 device-cell">
            <span class="text-charcoal font-medium">${device.plant_name || "N/A"}</span>
          </td>
          <td class="px-4 py-3 device-cell">
            <span class="text-charcoal">${device.alias || "N/A"}</span>
          </td>
          <td class="px-4 py-3 device-cell">
            <span class="text-slate-gray font-mono text-xs">${
              device.serial_number || "N/A"
            }</span>
          </td>
          <td class="px-4 py-3">
            <span class="${statusClass} status-indicator">
              ${device.status || "Unknown"}
            </span>
          </td>
          <td class="px-4 py-3">
            <span class="energy-value">${energyValue}</span>
          </td>
          <td class="px-4 py-3 text-slate-gray text-sm">${formattedDate}</td>
        `;

        tableBody.appendChild(row);
      });

      // Apply any active filters after rendering
      applyFilters();
    }

    function applyFilters() {
      const statusFilter = document.getElementById("status-filter").value;
      const searchQuery = document
        .getElementById("search-input")
        .value.toLowerCase();

      let visibleCount = 0;
      const rows = document.querySelectorAll("table tbody tr");

      rows.forEach((row) => {
        const deviceStatus = row.getAttribute("data-status");
        const rowText = row.textContent.toLowerCase();

        // Apply status filter
        const statusMatch =
          statusFilter === "all" || deviceStatus === statusFilter;

        // Apply search filter
        const searchMatch = !searchQuery || rowText.includes(searchQuery);

        // Show/hide the row based on combined filters
        if (statusMatch && searchMatch) {
          row.classList.remove("hidden");
          visibleCount++;
        } else {
          row.classList.add("hidden");
        }
      });

      // Show "no devices" message if all rows are filtered out
      if (visibleCount === 0 && rows.length > 0) {
        document.getElementById("no-devices").classList.remove("hidden");
      } else {
        document.getElementById("no-devices").classList.add("hidden");
      
      // Update the filters section to indicate active filters
      const filtersSection = document.getElementById("filters-section");
      if (statusFilter !== "all" || searchQuery) {
        filtersSection.classList.add("border-eco-green");
      } else {
        filtersSection.classList.remove("border-eco-green");
      }
    }

    function sortTable(columnIndex) {
      const table = document.querySelector("table");
      const tbody = table.querySelector("tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));

      // Get current sort order and update for next click
      let sortOrder = table.getAttribute("data-sort-order");
      sortOrder = sortOrder === "asc" ? "desc" : "asc";
      table.setAttribute("data-sort-order", sortOrder);

      // Update sort icons
      const headers = table.querySelectorAll("th");
      headers.forEach((header, index) => {
        const icon = header.querySelector(".sort-icon");
        if (icon) {
          icon.textContent =
            index === columnIndex ? (sortOrder === "asc" ? "▲" : "▼") : "▲";
        }
      });

      // Sort the rows
      rows.sort((a, b) => {
        const cellA = a.cells[columnIndex].textContent.trim();
        const cellB = b.cells[columnIndex].textContent.trim();

        // Special handling for energy values (remove "kWh" and parse as numbers)
        if (columnIndex === 4) {
          const numA = parseFloat(cellA.replace(/[^\d.-]/g, "")) || 0;
          const numB = parseFloat(cellB.replace(/[^\d.-]/g, "")) || 0;
          return sortOrder === "asc" ? numA - numB : numB - numA;
        }

        // Special handling for dates in last column
        if (columnIndex === 5) {
          const dateA = new Date(cellA);
          const dateB = new Date(cellB);

          if (!isNaN(dateA) && !isNaN(dateB)) {
            return sortOrder === "asc" ? dateA - dateB : dateB - dateA;
          }
        }

        // Default string comparison
        return sortOrder === "asc"
          ? cellA.localeCompare(cellB)
          : cellB.localeCompare(cellA);
      });

      // Rearrange the rows in the tbody
      rows.forEach((row) => tbody.appendChild(row));
      
      // Highlight sorted column
      headers.forEach((header, index) => {
        if (index === columnIndex) {
          header.classList.add("bg-deep-forest");
        } else {
          header.classList.remove("bg-deep-forest");
        }
      });
    }

    function exportToCSV() {
      // Get visible rows only
      const rows = Array.from(
        document.querySelectorAll("table tbody tr")
      ).filter((row) => !row.classList.contains("hidden"));

      if (rows.length === 0) {
        showError("No data to export.");
        return;
      }
      
      // Show visual feedback when exporting
      const exportBtn = document.getElementById("export-btn");
      const originalText = exportBtn.innerHTML;
      exportBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg><span>Exporting...</span>';
      exportBtn.disabled = true;

      // Build CSV content
      let csvContent = "data:text/csv;charset=utf-8,";

      // Add headers
      const headers = Array.from(document.querySelectorAll("table th")).map(
        (th) => `"${th.textContent.replace(/▲|▼/g, "").trim()}"`
      );
      csvContent += headers.join(",") + "\n";

      // Add rows
      rows.forEach((row) => {
        const rowData = Array.from(row.cells).map(
          (cell) => `"${cell.textContent.trim().replace(/"/g, '""')}"`
        );
        csvContent += rowData.join(",") + "\n";
      });

      // Create download link
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute(
        "download",
        `devices_${new Date().toISOString().slice(0, 10)}.csv`
      );
      document.body.appendChild(link);

      // Trigger download
      setTimeout(() => {
        link.click();
        document.body.removeChild(link);
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
      }, 500);
    }

    function showError(message) {
      const errorElement = document.getElementById("error-message");
      document.getElementById("error-text").textContent = message;
      errorElement.classList.remove("hidden");
    }

    function dismissError() {
      document.getElementById("error-message").classList.add("hidden");
    }

    // Handle responsive behavior on window resize
    window.addEventListener("resize", () => {
      if (window.innerWidth <= 640) {
        // Mobile adjustments
        document.querySelectorAll(".sort-icon").forEach((icon) => {
          icon.style.display = "none";
        });
      } else {
        // Desktop adjustments
        document.querySelectorAll(".sort-icon").forEach((icon) => {
          icon.style.display = "inline";
        });
      }
    });

    // Trigger resize handler on load
    const resizeEvent = new Event("resize");
    window.dispatchEvent(resizeEvent);
  });
</script>
{% endblock %}
