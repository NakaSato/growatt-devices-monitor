{% extends "base.html" %} {% block title %}Devices - Growatt API{% endblock %}
{% block content %}
<div class="container">
  <h1>Devices for Plant: {{ plant_name }}</h1>

  <div class="controls mb-3">
    <!-- Loading spinner -->
    <div id="loading" class="flex justify-center py-4" style="display: none">
      <div class="spinner border-2 border-t-2 rounded-full w-8 h-8"></div>
    </div>

    <!-- Export Button -->
    <button
      id="export-button"
      class="btn btn-primary"
      onclick="exportToExcel()"
    >
      <i class="fa fa-download"></i> Export to Excel
    </button>

    <!-- Refresh Button -->
    <button
      id="refresh-button"
      class="btn btn-secondary ms-2"
      onclick="fetchDevices(true)"
    >
      <i class="fa fa-sync"></i> Refresh Data
    </button>
  </div>

  <div class="table-responsive">
    <table
      id="devices-table"
      class="table table-striped table-hover"
      data-sort-order="asc"
    >
      <thead class="table-dark">
        <tr>
          <th onclick="sortTable(0)">
            Plant Name <span class="sort-icon">▲</span>
          </th>
          <th onclick="sortTable(1)">
            Device Alias <span class="sort-icon">▲</span>
          </th>
          <th onclick="sortTable(2)">
            Serial Number <span class="sort-icon">▲</span>
          </th>
          <th onclick="sortTable(3)">
            Status <span class="sort-icon">▲</span>
          </th>
          <th onclick="sortTable(4)">
            Total Energy <span class="sort-icon">▲</span>
          </th>
          <th onclick="sortTable(5)">
            Last Update Time <span class="sort-icon">▲</span>
          </th>
        </tr>
      </thead>
      <tbody>
        <!-- Data will be dynamically inserted here -->
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const plantId = "{{ plant_id }}";
    const cacheKey = `devices_${plantId}`;
    const cacheExpiration = 15 * 60 * 1000; // 15 minutes
    const apiUrl = "http://127.0.0.1:5000/api/devices/"; // Use Django URL tag for robustness
    const loadingSpinner = document.getElementById("loading");
    const devicesTable = document.getElementById("devices-table");
    const exportButton = document.getElementById("export-button");
    const refreshButton = document.getElementById("refresh-button");

    function renderDevices(data) {
      const devicesTableBody = devicesTable.querySelector("tbody");
      devicesTableBody.innerHTML = ""; // Clear existing rows

      if (!data || data.length === 0) {
        const emptyRow = document.createElement("tr");
        const emptyCell = document.createElement("td");
        emptyCell.textContent = "No device data available";
        emptyCell.colSpan = 6;
        emptyCell.className = "text-center";
        emptyRow.appendChild(emptyCell);
        devicesTableBody.appendChild(emptyRow);
        return;
      }

      data.forEach((device) => {
        const row = document.createElement("tr");
        if (device.status === "Offline") {
          row.classList.add("table-danger");
        }

        [
          "plant_name",
          "alias",
          "serial_number",
          "status",
          "total_energy",
          "last_update_time",
        ].forEach((field, index) => {
          const cell = document.createElement("td");

          if (field === "status") {
            const badge = document.createElement("span");
            badge.textContent = device[field] || "N/A";

            if (device[field] === "Offline") {
              badge.className =
                "inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-600 text-white";
            } else if (device[field] === "Online") {
              badge.className =
                "inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-600 text-white";
            } else {
              badge.className =
                "inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-600 text-white";
            }

            cell.appendChild(badge);
          } else {
            cell.textContent = device[field] || "N/A";
          }

          row.appendChild(cell);
        });

        devicesTableBody.appendChild(row);
      });
    }

    function fetchDevices(forceRefresh = false) {
      loadingSpinner.style.display = "flex";
      exportButton.disabled = true;
      refreshButton.disabled = true;

      // Check cache first unless forced refresh
      if (!forceRefresh) {
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
          const parsedCache = JSON.parse(cachedData);
          const isCacheValid =
            Date.now() - parsedCache.timestamp < cacheExpiration;

          if (isCacheValid) {
            renderDevices(parsedCache.data);
            loadingSpinner.style.display = "none";
            exportButton.disabled = false;
            refreshButton.disabled = false;
            return;
          }
        }
      }

      // Fetch new data
      fetch(apiUrl)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          // Cache the data with a timestamp
          const cacheData = {
            timestamp: Date.now(),
            data: data,
          };
          localStorage.setItem(cacheKey, JSON.stringify(cacheData));
          renderDevices(data);
        })
        .catch((error) => {
          console.error("Error fetching devices:", error);
          const devicesTableBody = devicesTable.querySelector("tbody");
          devicesTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">
            Error loading devices: ${error.message}</td></tr>`;
        })
        .finally(() => {
          loadingSpinner.style.display = "none";
          exportButton.disabled = false;
          refreshButton.disabled = false;
        });
    }

    function sortTable(columnIndex) {
      const rows = Array.from(devicesTable.rows).slice(1); // Exclude the header row
      const isAscending =
        devicesTable.getAttribute("data-sort-order") === "asc";
      const direction = isAscending ? 1 : -1;

      // Stop if no data to sort
      if (rows.length <= 1 && rows[0]?.cells.length === 1) return;

      rows.sort((a, b) => {
        const cellA = a.cells[columnIndex].textContent.trim();
        const cellB = b.cells[columnIndex].textContent.trim();

        // Handle numeric sorting
        if (!isNaN(cellA) && !isNaN(cellB)) {
          return direction * (parseFloat(cellA) - parseFloat(cellB));
        }

        // Try date sorting for the last column
        if (columnIndex === 5) {
          try {
            const dateA = new Date(cellA);
            const dateB = new Date(cellB);
            if (!isNaN(dateA) && !isNaN(dateB)) {
              return direction * (dateA - dateB);
            }
          } catch (e) {
            // Fall back to string comparison
          }
        }

        // String sorting
        return direction * cellA.localeCompare(cellB);
      });

      // Append sorted rows back to the table
      const tbody = devicesTable.querySelector("tbody");
      rows.forEach((row) => tbody.appendChild(row));

      // Toggle sort order
      devicesTable.setAttribute(
        "data-sort-order",
        isAscending ? "desc" : "asc"
      );

      // Update sort icons
      const headers = devicesTable.querySelectorAll("th");
      headers.forEach((header, index) => {
        const icon = header.querySelector(".sort-icon");
        if (icon) {
          icon.textContent =
            index === columnIndex ? (isAscending ? "▼" : "▲") : "▲";
        }
      });
    }

    window.exportToExcel = function () {
      // Show loading spinner during export
      loadingSpinner.style.display = "flex";

      // Create a new workbook and worksheet
      const workbook = new ExcelJS.Workbook();
      const worksheet = workbook.addWorksheet("Devices");

      // Set column definitions and widths
      worksheet.columns = [
        { header: "Plant Name", key: "plant", width: 15 },
        { header: "Device Alias", key: "alias", width: 15 },
        { header: "Serial Number", key: "serial", width: 20 },
        { header: "Status", key: "status", width: 10 },
        { header: "Total Energy", key: "energy", width: 12 },
        { header: "Last Update Time", key: "lastUpdate", width: 20 },
      ];

      // Add title row and merge cells
      worksheet.addRow([`Devices for Plant: {{ plant_name }}`]);
      worksheet.mergeCells("A1:F1");

      // Style the title row
      worksheet.getCell("A1").font = {
        bold: true,
        size: 16,
        color: { argb: "FFFFFF" },
      };
      worksheet.getCell("A1").fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "9fc5e8" },
      };
      worksheet.getCell("A1").alignment = {
        horizontal: "center",
        vertical: "middle",
      };
      worksheet.getRow(1).height = 30;

      // Add an empty row for spacing
      worksheet.addRow([]);

      // Style the header row
      const headerRow = worksheet.getRow(3);
      headerRow.eachCell((cell) => {
        cell.font = { bold: true, color: { argb: "FFFFFF" } };
        cell.fill = {
          type: "pattern",
          pattern: "solid",
          fgColor: { argb: "9fc5e8" },
        };
        cell.alignment = { horizontal: "center" };
        cell.border = {
          top: { style: "thin" },
          left: { style: "thin" },
          bottom: { style: "thin" },
          right: { style: "thin" },
        };
      });

      // Add column title row before header
      worksheet.spliceRows(3, 0, ["DEVICE INFORMATION"]);
      worksheet.mergeCells("A3:F3");
      worksheet.getCell("A3").font = {
        bold: true,
        size: 14,
        color: { argb: "FFFFFF" },
      };
      worksheet.getCell("A3").fill = {
        type: "pattern",
        pattern: "solid",
        fgColor: { argb: "9fc5e8" },
      };
      worksheet.getCell("A3").alignment = {
        horizontal: "center",
        vertical: "middle",
      };
      worksheet.getRow(3).height = 24;

      // Add data rows
      const rows = Array.from(devicesTable.querySelectorAll("tbody tr"));
      rows.forEach((row) => {
        const cells = Array.from(row.cells);
        const rowData = cells.map((cell) => cell.textContent.trim());
        worksheet.addRow(rowData);
      });

      // Add borders to all data cells
      const lastRowNum = rows.length + 4; // Title + Empty row + Column title + Header + Data rows
      worksheet.eachRow({ includeEmpty: true }, function (row, rowNumber) {
        if (rowNumber >= 4) {
          // Only style data rows and header
          row.eachCell({ includeEmpty: true }, function (cell) {
            cell.border = {
              top: { style: "thin" },
              left: { style: "thin" },
              bottom: { style: "thin" },
              right: { style: "thin" },
            };
          });
        }
      });

      // Generate timestamp for filename
      const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
      const fileName = `devices{{ plant_name }}-${timestamp}.xlsx`;

      // Write to blob and trigger download
      workbook.xlsx
        .writeBuffer()
        .then((buffer) => {
          const blob = new Blob([buffer], {
            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
          });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = fileName;
          a.click();
          window.URL.revokeObjectURL(url);
          loadingSpinner.style.display = "none";
        })
        .catch((err) => {
          console.error("Error creating Excel file:", err);
          loadingSpinner.style.display = "none";
        });
    };

    // Load ExcelJS library dynamically
    if (!window.ExcelJS) {
      const script = document.createElement("script");
      script.src =
        "https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js";
      script.async = true;
      script.onload = () => {
        console.log("ExcelJS loaded successfully");
        exportButton.disabled = false;
      };
      script.onerror = () => {
        console.error("Failed to load ExcelJS");
        exportButton.disabled = true;
      };
      document.head.appendChild(script);
    }

    // Expose sortTable to global scope for onclick handlers
    window.sortTable = sortTable;
    window.fetchDevices = fetchDevices;

    // Initial data load
    fetchDevices();
  });
</script>
{% endblock %}
