<!-- Configuration Component -->
<div class="space-y-6">
  <!-- Header Section -->
  <div class="bg-white shadow rounded-lg p-4 sm:p-6">
    <div class="md:flex md:items-center md:justify-between mb-4">
      <h2 class="text-xl font-bold leading-tight text-gray-900">
        System Configuration
      </h2>
      <div class="mt-3 md:mt-0 flex space-x-2">
        <button
          @click="saveConfiguration()"
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 mr-2"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
          Save Changes
        </button>
        <button
          @click="resetConfiguration()"
          class="inline-flex items-center px-4 py-2 border border-primary-600 text-sm font-medium rounded-md text-primary-600 bg-white hover:bg-primary-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 mr-2"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
          Reset
        </button>
      </div>
    </div>

    <!-- Configuration Tabs -->
    <div class="border-b border-gray-200 mb-5">
      <nav class="-mb-px flex space-x-6" aria-label="Configuration sections">
        <button
          @click="configSection = 'general'"
          :class="{ 'border-primary-600 text-primary-600': configSection === 'general', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': configSection !== 'general' }"
          class="whitespace-nowrap py-3 border-b-2 font-medium text-sm transition-colors"
        >
          General
        </button>
        <button
          @click="configSection = 'api'"
          :class="{ 'border-primary-600 text-primary-600': configSection === 'api', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': configSection !== 'api' }"
          class="whitespace-nowrap py-3 border-b-2 font-medium text-sm transition-colors"
        >
          API Settings
        </button>
        <button
          @click="configSection = 'notifications'"
          :class="{ 'border-primary-600 text-primary-600': configSection === 'notifications', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': configSection !== 'notifications' }"
          class="whitespace-nowrap py-3 border-b-2 font-medium text-sm transition-colors"
        >
          Notifications
        </button>
        <button
          @click="configSection = 'advanced'"
          :class="{ 'border-primary-600 text-primary-600': configSection === 'advanced', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': configSection !== 'advanced' }"
          class="whitespace-nowrap py-3 border-b-2 font-medium text-sm transition-colors"
        >
          Advanced
        </button>
      </nav>
    </div>

    <!-- General Configuration Section -->
    <div x-show="configSection === 'general'" class="space-y-5">
      <!-- System Name -->
      <div>
        <label for="system-name" class="block text-sm font-medium text-gray-700"
          >System Name</label
        >
        <div class="mt-1">
          <input
            type="text"
            name="system-name"
            id="system-name"
            x-model="configData.general.systemName"
            class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
            placeholder="Enter system name"
          />
        </div>
      </div>

      <!-- Default View -->
      <div>
        <label
          for="default-view"
          class="block text-sm font-medium text-gray-700"
          >Default View</label
        >
        <div class="mt-1">
          <select
            id="default-view"
            name="default-view"
            x-model="configData.general.defaultView"
            class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
          >
            <option value="dashboard">Dashboard</option>
            <option value="plants">Plants</option>
            <option value="devices">Devices</option>
            <option value="analytics">Analytics</option>
          </select>
        </div>
        <p class="mt-1 text-sm text-gray-500">
          Default view when users log in to the system
        </p>
      </div>

      <!-- Timezone Settings -->
      <div>
        <label for="timezone" class="block text-sm font-medium text-gray-700"
          >Timezone</label
        >
        <div class="mt-1">
          <select
            id="timezone"
            name="timezone"
            x-model="configData.general.timezone"
            class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
          >
            <option value="UTC">UTC</option>
            <option value="Asia/Bangkok">Asia/Bangkok</option>
            <option value="America/New_York">America/New_York</option>
            <option value="Europe/London">Europe/London</option>
            <option value="Asia/Tokyo">Asia/Tokyo</option>
          </select>
        </div>
      </div>

      <!-- Data Refresh Rate -->
      <div>
        <label
          for="refresh-rate"
          class="block text-sm font-medium text-gray-700"
          >Data Refresh Rate (seconds)</label
        >
        <div class="mt-1">
          <input
            type="number"
            name="refresh-rate"
            id="refresh-rate"
            x-model="configData.general.refreshRate"
            min="30"
            max="3600"
            class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
          />
        </div>
        <p class="mt-1 text-sm text-gray-500">
          How often data should be updated automatically (minimum 30 seconds)
        </p>
      </div>
    </div>

    <!-- API Configuration Section -->
    <div x-show="configSection === 'api'" class="space-y-5">
      <!-- API URL -->
      <div>
        <label for="api-url" class="block text-sm font-medium text-gray-700"
          >Growatt API URL</label
        >
        <div class="mt-1">
          <input
            type="text"
            name="api-url"
            id="api-url"
            x-model="configData.api.baseUrl"
            class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
            placeholder="https://server.growatt.com/api/"
          />
        </div>
      </div>

      <!-- API Timeout -->
      <div>
        <label for="api-timeout" class="block text-sm font-medium text-gray-700"
          >API Timeout (seconds)</label
        >
        <div class="mt-1">
          <input
            type="number"
            name="api-timeout"
            id="api-timeout"
            x-model="configData.api.timeout"
            min="5"
            max="60"
            class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
          />
        </div>
      </div>

      <!-- API Request Limit -->
      <div>
        <label for="api-limit" class="block text-sm font-medium text-gray-700"
          >API Rate Limit (requests per minute)</label
        >
        <div class="mt-1">
          <input
            type="number"
            name="api-limit"
            id="api-limit"
            x-model="configData.api.rateLimit"
            min="1"
            max="300"
            class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
          />
        </div>
        <p class="mt-1 text-sm text-gray-500">
          Limit to avoid hitting Growatt API restrictions
        </p>
      </div>

      <!-- API Cache Duration -->
      <div>
        <label for="api-cache" class="block text-sm font-medium text-gray-700"
          >Cache Duration (minutes)</label
        >
        <div class="mt-1">
          <input
            type="number"
            name="api-cache"
            id="api-cache"
            x-model="configData.api.cacheDuration"
            min="1"
            max="60"
            class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
          />
        </div>
        <p class="mt-1 text-sm text-gray-500">
          How long to cache API responses to reduce calls
        </p>
      </div>
    </div>

    <!-- Notifications Configuration Section -->
    <div x-show="configSection === 'notifications'" class="space-y-5">
      <!-- Enable Email Notifications -->
      <div class="relative flex items-start">
        <div class="flex items-center h-5">
          <input
            id="enable-email"
            name="enable-email"
            type="checkbox"
            x-model="configData.notifications.enableEmail"
            class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300 rounded"
          />
        </div>
        <div class="ml-3 text-sm">
          <label for="enable-email" class="font-medium text-gray-700"
            >Enable Email Notifications</label
          >
          <p class="text-gray-500">
            Receive system alerts and reports via email
          </p>
        </div>
      </div>

      <!-- Email Settings (shown when email is enabled) -->
      <div x-show="configData.notifications.enableEmail" class="pl-7 space-y-4">
        <!-- Email Address -->
        <div>
          <label
            for="email-address"
            class="block text-sm font-medium text-gray-700"
            >Email Address</label
          >
          <div class="mt-1">
            <input
              type="email"
              name="email-address"
              id="email-address"
              x-model="configData.notifications.emailAddress"
              class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
              placeholder="your@email.com"
            />
          </div>
        </div>

        <!-- Email Frequency -->
        <div>
          <label
            for="email-frequency"
            class="block text-sm font-medium text-gray-700"
            >Email Frequency</label
          >
          <div class="mt-1">
            <select
              id="email-frequency"
              name="email-frequency"
              x-model="configData.notifications.emailFrequency"
              class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
            >
              <option value="immediate">Immediate</option>
              <option value="hourly">Hourly Digest</option>
              <option value="daily">Daily Digest</option>
              <option value="weekly">Weekly Report</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Enable Push Notifications -->
      <div class="relative flex items-start">
        <div class="flex items-center h-5">
          <input
            id="enable-push"
            name="enable-push"
            type="checkbox"
            x-model="configData.notifications.enablePush"
            class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300 rounded"
          />
        </div>
        <div class="ml-3 text-sm">
          <label for="enable-push" class="font-medium text-gray-700"
            >Enable Push Notifications</label
          >
          <p class="text-gray-500">Receive real-time alerts on your device</p>
        </div>
      </div>

      <!-- Push Settings (shown when push is enabled) -->
      <div x-show="configData.notifications.enablePush" class="pl-7 space-y-4">
        <!-- Notification Types -->
        <div>
          <label class="block text-sm font-medium text-gray-700"
            >Notification Types</label
          >
          <div class="mt-2 space-y-2">
            <div class="relative flex items-start">
              <div class="flex items-center h-5">
                <input
                  id="notify-alerts"
                  name="notify-alerts"
                  type="checkbox"
                  x-model="configData.notifications.notifyAlerts"
                  class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300 rounded"
                />
              </div>
              <div class="ml-3 text-sm">
                <label for="notify-alerts" class="font-medium text-gray-700"
                  >System Alerts</label
                >
              </div>
            </div>
            <div class="relative flex items-start">
              <div class="flex items-center h-5">
                <input
                  id="notify-performance"
                  name="notify-performance"
                  type="checkbox"
                  x-model="configData.notifications.notifyPerformance"
                  class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300 rounded"
                />
              </div>
              <div class="ml-3 text-sm">
                <label
                  for="notify-performance"
                  class="font-medium text-gray-700"
                  >Performance Updates</label
                >
              </div>
            </div>
            <div class="relative flex items-start">
              <div class="flex items-center h-5">
                <input
                  id="notify-maintenance"
                  name="notify-maintenance"
                  type="checkbox"
                  x-model="configData.notifications.notifyMaintenance"
                  class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300 rounded"
                />
              </div>
              <div class="ml-3 text-sm">
                <label
                  for="notify-maintenance"
                  class="font-medium text-gray-700"
                  >Maintenance Reminders</label
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Advanced Configuration Section -->
    <div x-show="configSection === 'advanced'" class="space-y-5">
      <!-- Debug Mode -->
      <div class="relative flex items-start">
        <div class="flex items-center h-5">
          <input
            id="debug-mode"
            name="debug-mode"
            type="checkbox"
            x-model="configData.advanced.debugMode"
            class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300 rounded"
          />
        </div>
        <div class="ml-3 text-sm">
          <label for="debug-mode" class="font-medium text-gray-700"
            >Debug Mode</label
          >
          <p class="text-gray-500">
            Enable additional logging and debugging information
          </p>
        </div>
      </div>

      <!-- Database Settings -->
      <div>
        <h3 class="text-sm font-medium text-gray-700 mb-3">
          Database Settings
        </h3>

        <!-- Database Type -->
        <div class="mb-4">
          <label for="db-type" class="block text-sm font-medium text-gray-700"
            >Database Type</label
          >
          <div class="mt-1">
            <select
              id="db-type"
              name="db-type"
              x-model="configData.advanced.dbType"
              class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
            >
              <option value="sqlite">SQLite (Default)</option>
              <option value="mysql">MySQL</option>
              <option value="postgres">PostgreSQL</option>
            </select>
          </div>
        </div>

        <!-- Database Connection String (For MySQL/PostgreSQL) -->
        <div x-show="configData.advanced.dbType !== 'sqlite'">
          <label
            for="db-connection"
            class="block text-sm font-medium text-gray-700"
            >Connection String</label
          >
          <div class="mt-1">
            <input
              type="text"
              name="db-connection"
              id="db-connection"
              x-model="configData.advanced.dbConnection"
              class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
              placeholder="mysql://user:password@localhost/dbname"
            />
          </div>
        </div>
      </div>

      <!-- Data Retention -->
      <div>
        <label
          for="data-retention"
          class="block text-sm font-medium text-gray-700"
          >Data Retention Period (days)</label
        >
        <div class="mt-1">
          <input
            type="number"
            name="data-retention"
            id="data-retention"
            x-model="configData.advanced.dataRetention"
            min="7"
            max="365"
            class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
          />
        </div>
        <p class="mt-1 text-sm text-gray-500">
          How long to store historical data before automatic cleanup
        </p>
      </div>

      <!-- Enable ML Features -->
      <div class="relative flex items-start">
        <div class="flex items-center h-5">
          <input
            id="enable-ml"
            name="enable-ml"
            type="checkbox"
            x-model="configData.advanced.enableML"
            class="focus:ring-primary-500 h-4 w-4 text-primary-600 border-gray-300 rounded"
          />
        </div>
        <div class="ml-3 text-sm">
          <label for="enable-ml" class="font-medium text-gray-700"
            >Enable ML Features</label
          >
          <p class="text-gray-500">
            Use machine learning for predictions and anomaly detection
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("alpine:init", () => {
    // Extend operationsApp with configuration functionality
    Alpine.data("operationsApp", (app) => ({
      // Add configuration-specific properties
      configSection: "general",
      configChanged: false,
      configData: {
        general: {
          systemName: "Growatt Monitoring System",
          defaultView: "dashboard",
          timezone: "UTC",
          refreshRate: 60,
        },
        api: {
          baseUrl: "https://server.growatt.com/api/",
          timeout: 10,
          rateLimit: 60,
          cacheDuration: 5,
        },
        notifications: {
          enableEmail: false,
          emailAddress: "",
          emailFrequency: "daily",
          enablePush: false,
          notifyAlerts: true,
          notifyPerformance: false,
          notifyMaintenance: true,
        },
        advanced: {
          debugMode: false,
          dbType: "sqlite",
          dbConnection: "",
          dataRetention: 90,
          enableML: true,
        },
      },

      // Initialize configuration
      initConfiguration() {
        // Load configuration from the server
        fetch("/api/system/configuration")
          .then((response) => {
            if (response.ok) return response.json();
            throw new Error("Failed to load configuration");
          })
          .then((data) => {
            this.configData = data;
          })
          .catch((error) => {
            console.error("Error loading configuration:", error);
            // Keep using default values if loading fails
          });
      },

      // Save configuration changes
      saveConfiguration() {
        this.isLoading = true;

        fetch("/api/system/configuration", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(this.configData),
        })
          .then((response) => {
            if (response.ok) return response.json();
            throw new Error("Failed to save configuration");
          })
          .then((data) => {
            this.isLoading = false;
            this.configChanged = false;

            // Show success message
            alert("Configuration saved successfully");
          })
          .catch((error) => {
            this.isLoading = false;
            console.error("Error saving configuration:", error);

            // Show error message
            alert("Failed to save configuration. Please try again.");
          });
      },

      // Reset configuration to default or last saved
      resetConfiguration() {
        if (
          confirm("Are you sure you want to reset all configuration changes?")
        ) {
          this.initConfiguration();
          this.configChanged = false;
        }
      },
    }));
  });
</script>
