<!-- System Status Overview Component -->
<div class="system-status-container" x-data="{ activeTab: 'overview' }">
  <!-- System Status Header -->
  {% include 'components/metrics/system_metrics.html' %}

  <!-- Overview Tab (Default) -->
  {% include 'components/tab-overview.html' %}

  <!-- System Health Metrics -->
  {% include 'components/metrics/system_health_metrics.html' %}

  <div
    x-show="activeTab === 'overview'"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
  >
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6">
      <!-- Power Flow Card -->
      {% include 'components/cards/power_flow_card.html' %}

      <!-- System Health Card -->
      {% include 'components/cards/system_health_card.html' %}

      <!-- Daily Energy Card -->
      {% include 'components/cards/daily_energy_card.html' %}
    </div>
  </div>

  <!-- Alerts Tab -->
  {% include 'components/tabs/alerts_tab.html' %}

  <!-- Analytics Tab -->
  {% include 'components/tabs/analytics_tab.html' %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Global variables for charts
    let efficiencyChart = null;
    let distributionChart = null;
    let chartData = {
      efficiency: null,
      distribution: null,
    };
    let dataCache = {};
    let isAnalyticsInitialized = false;

    // Function to initialize analytics when tab is shown
    window.initAnalytics = function () {
      if (!isAnalyticsInitialized) {
        loadAnalyticsData(14); // Default to 14 days
        isAnalyticsInitialized = true;
      }
    };

    // Function to update chart data based on selection
    window.updateChartData = function (days) {
      showLoading();
      loadAnalyticsData(days);
    };

    // Show/hide UI elements
    function showLoading() {
      document.getElementById("analytics-loading").classList.remove("hidden");
      document.getElementById("analytics-content").classList.add("hidden");
      document.getElementById("analytics-error").classList.add("hidden");
    }

    function showError() {
      document.getElementById("analytics-loading").classList.add("hidden");
      document.getElementById("analytics-content").classList.add("hidden");
      document.getElementById("analytics-error").classList.remove("hidden");
    }

    function showContent() {
      document.getElementById("analytics-loading").classList.add("hidden");
      document.getElementById("analytics-content").classList.remove("hidden");
      document.getElementById("analytics-error").classList.add("hidden");
    }

    // Load analytics data
    function loadAnalyticsData(days) {
      // Check if data is already in cache
      if (dataCache[days]) {
        updateUIWithData(dataCache[days]);
        showContent();
        return;
      }

      // Simulate API request with timeout
      setTimeout(() => {
        try {
          // Generate data for the requested period
          const data = generateAnalyticsData(days);

          // Cache the data
          dataCache[days] = data;

          // Update UI
          updateUIWithData(data);
          showContent();
        } catch (error) {
          console.error("Error loading analytics data:", error);
          showError();
        }
      }, 700); // Simulate network delay
    }

    // Update UI elements with new data
    function updateUIWithData(data) {
      // ...existing code...
    }

    // Update efficiency trend chart
    function updateEfficiencyChart(data) {
      // ...existing code...
    }

    // Update distribution chart
    function updateDistributionChart(data) {
      // ...existing code...
    }

    // Generate analytics data with a specified time range
    function generateAnalyticsData(days) {
      // ...existing code...
    }

    // Add event listener for time range selector
    document
      .getElementById("timeRange")
      ?.addEventListener("change", function (e) {
        updateChartData(e.target.value);
      });

    // Add event listener for retry button
    document
      .getElementById("retry-analytics")
      ?.addEventListener("click", function () {
        const days = document.getElementById("timeRange").value;
        showLoading();
        loadAnalyticsData(days);
      });

    // Window resize handler for responsive charts
    let resizeTimeout;
    window.addEventListener("resize", function () {
      // ...existing code...
    });

    // Add custom event to trigger tab changes
    document.querySelectorAll("[x-data]").forEach((element) => {
      // ...existing code...
    });

    // Helper functions
    function generateDateLabels(days) {
      // ...existing code...
    }

    function generateEfficiencyData(days) {
      // ...existing code...
    }

    // Create simple donut chart for daily energy on the overview tab
    const donutCtx = document
      .getElementById("dailyEnergyDonut")
      ?.getContext("2d");

    if (donutCtx) {
      // ...existing code...
    }
  });
</script>
