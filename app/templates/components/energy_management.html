{% extends "base.html" %} {% block title %}Energy Management - Growatt API{%
endblock %} {% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %} {% block content %}
<div id="energy-management" class="energy-management-container" v-cloak>
  <div class="energy-management-header">
    <h2 class="energy-management-title">
      Energy Management <span class="info-icon">â“˜</span>
    </h2>
    <div class="date-selector">
      <button class="date-navigation" @click="previousDate">&#10094;</button>
      <span class="current-date">${ selectedDate }</span>
      <button class="date-navigation" @click="nextDate">&#10095;</button>
    </div>
  </div>

  <div class="period-tabs">
    <button
      v-for="tab in periodTabs"
      :key="tab"
      :class="['period-tab', { active: currentPeriod === tab }]"
      @click="changePeriod(tab)"
    >
      ${ tab }
    </button>
  </div>

  <!-- Loading indicator -->
  <div v-if="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading energy data...</p>
  </div>

  <div v-else class="energy-stats">
    <div class="energy-stat-container">
      <div class="energy-metric">
        <div class="energy-metric-label">Yield:</div>
        <span class="energy-metric-value">${ energyData.yieldValue }</span>
        <span class="energy-metric-unit">kWh</span>
      </div>
      <div class="energy-metric">
        <span class="energy-metric-value" style="color: #22c55e"
          >${ energyData.yieldTotal }</span
        >
        <div class="energy-metric-label">Consumed (kWh)</div>
      </div>
    </div>
  </div>

  <div class="energy-flow-visualization">
    <!-- ...existing code... -->
  </div>

  <div class="energy-chart">
    <canvas id="energyFlowChart" ref="energyFlowChart"></canvas>
  </div>

  <!-- Power distribution chart -->
  <div class="energy-distribution-chart">
    <h3>Power Distribution</h3>
    <div id="powerDistributionDonut" style="height: 300px"></div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const energyManagementApp = Vue.createApp({
      delimiters: ["${", "}"], // Use different delimiters to avoid conflict with Jinja2
      data() {
        return {
          selectedDate: new Date().toISOString().split("T")[0],
          currentPeriod: "Day",
          periodTabs: ["Day", "Month", "Year", "Lifetime"],
          isLoading: true,
          energyData: {
            yieldValue: "0.00",
            yieldTotal: "0.00",
            consumptionValue: "0.00",
            gridFedValue: "0.00",
            fromPvValue: "0.00",
            fromGridValue: "0.00",
          },
          flowPercentages: {
            consumed: 100.0,
            fedGrid: 0.0,
            fromPV: 0.0,
            fromGrid: 0.0,
          },
          tooltip: {
            show: false,
            top: 0,
            left: 0,
            time: "",
            metrics: [],
          },
          chart: null,
          powerDistChart: null,
          systemCapacity: 10, // System capacity in kW
        };
      },
      mounted() {
        this.loadEnergyData();
      },
      methods: {
        loadEnergyData() {
          this.isLoading = true;

          // Simulate API call with delay
          setTimeout(() => {
            this.fetchOrGenerateEnergyData();
          }, 800);
        },

        fetchOrGenerateEnergyData() {
          const dateObj = new Date(this.selectedDate);

          try {
            // Try to fetch real data from API (if available)
            fetch(
              `/api/energy?period=${this.currentPeriod.toLowerCase()}&date=${
                this.selectedDate
              }`
            )
              .then((response) => {
                if (!response.ok) {
                  throw new Error("API data not available");
                }
                return response.json();
              })
              .then((data) => {
                this.processEnergyData(data);
              })
              .catch((error) => {
                console.log("Using generated data:", error.message);
                // If API fails, generate realistic data
                this.generateEnergyData(dateObj);
              })
              .finally(() => {
                this.isLoading = false;
                this.initCharts();
              });
          } catch (error) {
            // Fallback to generated data
            console.log("Using generated data due to error:", error);
            this.generateEnergyData(dateObj);
            this.isLoading = false;
            this.initCharts();
          }
        },

        generateEnergyData(date) {
          // Use our utility to generate realistic energy data
          if (window.EnergyDataUtils) {
            const period = this.currentPeriod.toLowerCase();
            const data = window.EnergyDataUtils.generateEnergyData(
              period,
              this.systemCapacity,
              date
            );

            // Update our component data
            this.energyData = {
              yieldValue: data.totals.production,
              yieldTotal: data.totals.selfConsumption,
              consumptionValue: data.totals.consumption,
              gridFedValue: data.totals.gridExport,
              fromPvValue: data.totals.selfConsumption,
              fromGridValue: data.totals.gridImport,
            };

            // Update flow percentages
            this.flowPercentages = {
              consumed: 100,
              fedGrid: parseFloat(data.percentages.gridExport),
              fromPV: parseFloat(data.percentages.selfConsumption),
              fromGrid: parseFloat(data.percentages.gridImport),
            };

            // Save generated data for charts
            this.chartData = data;
          } else {
            // Fallback if utilities aren't available
            console.error("Energy data utilities not available");
            this.energyData = {
              yieldValue: "20.53",
              yieldTotal: "20.53",
              consumptionValue: "77.56",
              gridFedValue: "0.00",
              fromPvValue: "20.53",
              fromGridValue: "57.03",
            };

            this.flowPercentages = {
              consumed: 100.0,
              fedGrid: 0.0,
              fromPV: 26.47,
              fromGrid: 73.53,
            };
          }
        },

        processEnergyData(apiData) {
          // Process data from the API
          // This would be used for real API responses
          // For now, we just use the generated data
          this.energyData = {
            yieldValue: apiData.totalProduction || "0.00",
            yieldTotal: apiData.selfConsumption || "0.00",
            consumptionValue: apiData.totalConsumption || "0.00",
            gridFedValue: apiData.gridExport || "0.00",
            fromPvValue: apiData.selfConsumption || "0.00",
            fromGridValue: apiData.gridImport || "0.00",
          };

          const totalProduction = parseFloat(this.energyData.yieldValue);
          const totalConsumption = parseFloat(this.energyData.consumptionValue);

          // Calculate percentages if we have valid numbers
          if (totalProduction > 0 && totalConsumption > 0) {
            const selfConsumptionPct =
              (parseFloat(this.energyData.fromPvValue) / totalProduction) * 100;
            const gridExportPct =
              (parseFloat(this.energyData.gridFedValue) / totalProduction) *
              100;
            const gridImportPct =
              (parseFloat(this.energyData.fromGridValue) / totalConsumption) *
              100;

            this.flowPercentages = {
              consumed: 100,
              fedGrid: gridExportPct,
              fromPV: selfConsumptionPct,
              fromGrid: gridImportPct,
            };
          }

          // Store data for charts
          this.chartData = apiData;
        },

        initChart() {
          try {
            const ctx = this.$refs.energyFlowChart.getContext("2d");

            if (this.chart) {
              this.chart.destroy();
            }

            // Register Chart.js plugins if needed
            if (
              Chart.registry &&
              Chart.registry.plugins &&
              typeof ChartDataLabels !== "undefined" &&
              !Chart.registry.plugins.get("datalabels")
            ) {
              Chart.register(ChartDataLabels);
            }

            // Prepare chart data
            let chartData = {
              labels: [],
              datasets: [],
            };

            if (this.chartData && this.chartData.labels) {
              // Use our generated/API data
              chartData.labels = this.chartData.labels;

              chartData.datasets = [
                {
                  label: "PV Output",
                  data: this.chartData.datasets.production,
                  backgroundColor: "rgba(16, 185, 129, 0.2)", // Green
                  borderColor: "rgba(16, 185, 129, 1)",
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 2,
                },
                {
                  label: "Consumption",
                  data: this.chartData.datasets.consumption,
                  backgroundColor: "rgba(249, 115, 22, 0.2)", // Orange
                  borderColor: "rgba(249, 115, 22, 1)",
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 2,
                },
                {
                  label: "Grid Exchange",
                  data: this.chartData.datasets.gridExchange,
                  backgroundColor: "rgba(59, 130, 246, 0.2)", // Blue
                  borderColor: "rgba(59, 130, 246, 1)",
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 2,
                },
              ];
            } else {
              // Fallback to static data
              const period = this.currentPeriod.toLowerCase();
              let labels = [];

              switch (period) {
                case "day":
                  labels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
                  break;
                case "month":
                  labels = Array.from({ length: 30 }, (_, i) => `${i + 1}`);
                  break;
                case "year":
                  labels = [
                    "Jan",
                    "Feb",
                    "Mar",
                    "Apr",
                    "May",
                    "Jun",
                    "Jul",
                    "Aug",
                    "Sep",
                    "Oct",
                    "Nov",
                    "Dec",
                  ];
                  break;
                default:
                  labels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
              }

              chartData.labels = labels;
              chartData.datasets = [
                {
                  label: "PV Output",
                  data: Array.from(
                    { length: labels.length },
                    () => Math.random() * 10
                  ),
                  backgroundColor: "rgba(16, 185, 129, 0.2)",
                  borderColor: "rgba(16, 185, 129, 1)",
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 2,
                },
                {
                  label: "Consumption",
                  data: Array.from(
                    { length: labels.length },
                    () => Math.random() * 15
                  ),
                  backgroundColor: "rgba(249, 115, 22, 0.2)",
                  borderColor: "rgba(249, 115, 22, 1)",
                  borderWidth: 2,
                  fill: true,
                  tension: 0.4,
                  pointRadius: 2,
                },
              ];
            }

            const config = {
              type: "line",
              data: chartData,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  mode: "index",
                  intersect: false,
                },
                plugins: {
                  datalabels: {
                    display: false, // Hide datalabels for this chart
                  },
                  legend: {
                    display: true,
                    position: "top",
                    labels: {
                      usePointStyle: true,
                      padding: 15,
                    },
                  },
                  tooltip: {
                    enabled: false, // We'll create our custom tooltip
                    external: (context) => {
                      const { chart, tooltip } = context;

                      if (tooltip.opacity === 0) {
                        this.tooltip.show = false;
                        return;
                      }

                      const position = chart.canvas.getBoundingClientRect();
                      this.tooltip.left = position.left + tooltip.caretX;
                      this.tooltip.top = position.top + tooltip.caretY;
                      this.tooltip.show = true;

                      // Get data
                      this.tooltip.time =
                        chartData.labels[tooltip.dataPoints[0].dataIndex];

                      // Create metrics data
                      this.tooltip.metrics = tooltip.dataPoints.map((point) => {
                        const unit =
                          point.datasetIndex === 2
                            ? point.raw >= 0
                              ? "kWh (Import)"
                              : "kWh (Export)"
                            : "kWh";

                        return {
                          colorClass:
                            point.datasetIndex === 0
                              ? "pv-color"
                              : point.datasetIndex === 1
                              ? "consumption-color"
                              : "grid-color",
                          label: chartData.datasets[point.datasetIndex].label,
                          value: `${Math.abs(point.raw)} ${unit}`,
                        };
                      });
                    },
                  },
                  title: {
                    display: true,
                    text: `Energy Flow - ${this.currentPeriod}`,
                    font: {
                      size: 16,
                    },
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: "Energy (kWh)",
                    },
                    grid: {
                      color: "rgba(243, 244, 246, 0.7)",
                      drawBorder: false,
                    },
                    ticks: {
                      padding: 10,
                      color: "#6b7280",
                      callback: function (value) {
                        return value + " kWh";
                      },
                      font: {
                        size: 11,
                      },
                    },
                  },
                  x: {
                    grid: {
                      display: false,
                    },
                    ticks: {
                      padding: 10,
                      color: "#6b7280",
                      font: {
                        size: 11,
                      },
                    },
                  },
                },
              },
            };

            this.chart = new Chart(ctx, config);
          } catch (error) {
            console.error("Error initializing energy flow chart:", error);
          }
        },

        initPowerDistributionChart() {
          try {
            // Initialize donut chart with ApexCharts
            // Use real data from our energy data metrics
            const selfConsumption = parseFloat(this.energyData.fromPvValue);
            const gridExport = parseFloat(this.energyData.gridFedValue);
            const gridImport = parseFloat(this.energyData.fromGridValue);

            const series = [selfConsumption, gridExport, gridImport];
            const labels = ["Self Consumption", "Grid Export", "Grid Import"];

            const options = {
              series: series,
              labels: labels,
              chart: {
                type: "donut",
                height: 300,
              },
              colors: ["#10b981", "#3b82f6", "#f59e0b"],
              plotOptions: {
                pie: {
                  donut: {
                    size: "65%",
                    labels: {
                      show: true,
                      name: {
                        show: true,
                      },
                      value: {
                        show: true,
                        formatter: function (val) {
                          return val + " kWh";
                        },
                      },
                      total: {
                        show: true,
                        label: "Total Energy",
                        formatter: function (w) {
                          return (
                            w.globals.seriesTotals.reduce((a, b) => a + b, 0) +
                            " kWh"
                          );
                        },
                      },
                    },
                  },
                },
              },
              dataLabels: {
                enabled: false,
              },
              legend: {
                position: "bottom",
                offsetY: 0,
              },
              tooltip: {
                y: {
                  formatter: function (val) {
                    return val + " kWh";
                  },
                },
              },
              stroke: {
                width: 2,
              },
              responsive: [
                {
                  breakpoint: 480,
                  options: {
                    chart: {
                      height: 250,
                    },
                    legend: {
                      position: "bottom",
                    },
                  },
                },
              ],
            };

            // Initialize chart only after the DOM element is available
            setTimeout(() => {
              if (document.getElementById("powerDistributionDonut")) {
                if (this.powerDistChart) {
                  this.powerDistChart.destroy();
                }
                this.powerDistChart = new ApexCharts(
                  document.getElementById("powerDistributionDonut"),
                  options
                );
                this.powerDistChart.render();
              }
            }, 0);
          } catch (error) {
            console.error(
              "Error initializing power distribution chart:",
              error
            );
          }
        },

        initCharts() {
          this.initChart();
          this.initPowerDistributionChart();
        },

        previousDate() {
          const date = new Date(this.selectedDate);

          // Adjust date based on current period
          switch (this.currentPeriod.toLowerCase()) {
            case "day":
              date.setDate(date.getDate() - 1);
              break;
            case "month":
              date.setMonth(date.getMonth() - 1);
              break;
            case "year":
              date.setFullYear(date.getFullYear() - 1);
              break;
            default:
              date.setDate(date.getDate() - 1);
          }

          this.selectedDate = date.toISOString().split("T")[0];
          this.loadEnergyData();
        },

        nextDate() {
          const date = new Date(this.selectedDate);
          const today = new Date();

          // Adjust date based on current period
          switch (this.currentPeriod.toLowerCase()) {
            case "day":
              date.setDate(date.getDate() + 1);
              break;
            case "month":
              date.setMonth(date.getMonth() + 1);
              break;
            case "year":
              date.setFullYear(date.getFullYear() + 1);
              break;
            default:
              date.setDate(date.getDate() + 1);
          }

          // Don't allow future dates
          if (date <= today) {
            this.selectedDate = date.toISOString().split("T")[0];
            this.loadEnergyData();
          }
        },

        changePeriod(period) {
          this.currentPeriod = period;
          this.loadEnergyData();
        },
      },
      beforeUnmount() {
        if (this.chart) {
          this.chart.destroy();
        }
        if (this.powerDistChart) {
          this.powerDistChart.destroy();
        }
      },
    }).mount("#energy-management");
  });
</script>

<style>
  .loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 0;
  }

  .loading-spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #10b981;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1.5s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .energy-distribution-chart {
    margin-top: 30px;
    padding: 15px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .energy-distribution-chart h3 {
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.25rem;
    color: #374151;
  }

  .grid-color {
    background-color: rgba(59, 130, 246, 1);
  }
</style>
{% endblock %}
