<header
  class="overflow-hidden shadow-sm backdrop-blur-sm top-0 w-full z-50 transition-colors duration-300"
  id="site-header"
>
  <div class="absolute inset-0 bg-pattern opacity-5 z-0"></div>
  <!-- Status bar with enhanced responsive support -->
  <div
    class="py-1 border-b border-gray-700/50 relative z-20 bg-gradient-to-r from-slate-800 to-slate-900 w-full"
  >
    <div class="container mx-auto px-2 sm:px-4">
      <div class="flex justify-between items-center text-xs">
        <div class="flex items-center space-x-1 sm:space-x-6">
          <div class="flex items-center px-2 py-1">
            <span
              class="inline-block w-2 h-2 bg-emerald-500 rounded-full mr-1.5 sm:mr-2 animate-pulse shadow-[0_0_8px_rgba(16,185,129,0.6)]"
              aria-hidden="true"
            ></span>
            <span
              class="text-emerald-200 font-medium tracking-wider text-[10px] xs:text-xs uppercase"
              >System Online</span
            >
          </div>
          <div class="hidden xs:flex items-center gap-2 px-2 py-1">
            <span
              class="text-slate-400 text-xs font-light tracking-wide"
              id="current-date"
            ></span>
            <span
              class="text-slate-300 font-mono font-medium tabular-nums text-xs tracking-tight"
              id="current-time"
            ></span>
          </div>
        </div>
        <div
          class="hidden sm:flex items-center space-x-2 md:space-x-4"
          aria-label="System Metrics"
        >
          <!-- Metrics badges with better spacing for small/medium screens -->
          <div
            class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1 rounded-md border bg-emerald-900/40 border-emerald-700/30 text-emerald-300"
            aria-label="Generation"
          >
            <span
              class="text-slate-400 text-[10px] xs:text-xs uppercase tracking-wider"
              id="generation-label"
              >Gen:</span
            >
            <span
              class="font-medium tabular-nums text-xs sm:text-sm"
              id="generation-value"
              aria-labelledby="generation-label"
              >9.7 kWh</span
            >
          </div>
          <div
            class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1 rounded-md border bg-blue-900/40 border-blue-700/30 text-blue-300"
            aria-label="Consumption"
          >
            <span
              class="text-slate-400 text-[10px] xs:text-xs uppercase tracking-wider"
              id="consumption-label"
              >Cons:</span
            >
            <span
              class="font-medium tabular-nums text-xs sm:text-sm"
              id="consumption-value"
              aria-labelledby="consumption-label"
              >6.4 kWh</span
            >
          </div>
          <div
            class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1 rounded-md border bg-amber-900/40 border-amber-700/30 text-amber-300"
            aria-label="Efficiency"
          >
            <span
              class="text-slate-400 text-[10px] xs:text-xs uppercase tracking-wider"
              id="efficiency-label"
              >Eff:</span
            >
            <span
              class="font-medium tabular-nums text-xs sm:text-sm"
              id="efficiency-value"
              aria-labelledby="efficiency-label"
              >92.8%</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main navigation bar with improved responsive design -->
  <nav
    class="px-2 xs:px-4 py-2 xs:py-3 relative z-10 bg-white shadow-md border-b border-gray-200 transition-all duration-300"
    id="main-nav"
    aria-label="Main navigation"
  >
    <div class="lg:container lg:mx-auto">
      <!-- Mobile menu button and logo -->
      <div class="flex items-center justify-between lg:hidden">
        <a href="/" class="flex items-center group" aria-label="Home">
          <div class="relative">
            <img
              src="{{ url_for('static', filename='images/Growatt-logo.png') }}"
              alt="Growatt Monitor Logo"
              class="h-8 xs:h-10 sm:h-12"
            />
          </div>
        </a>
        <div class="flex items-center">
          <button
            id="mobile-menu-button"
            class="text-slate-700 bg-slate-100 px-3 py-2 rounded-md hover:bg-slate-200 transition-colors flex items-center justify-center w-10 h-10"
            aria-expanded="false"
            aria-controls="mobile-menu"
            aria-label="Toggle menu"
          >
            <i class="fas fa-bars" id="menu-icon-bars"></i>
            <i class="fas fa-times hidden" id="menu-icon-close"></i>
          </button>
        </div>
      </div>

      <!-- Desktop menu -->
      <div class="hidden lg:flex items-center justify-between py-1">
        <!-- Logo and main links -->
        <div class="flex items-center">
          <a
            href="/"
            class="flex items-center gap-2.5 mr-8 group"
            aria-label="Home"
          >
            <div class="mr-2 relative">
              <img
                src="{{ url_for('static', filename='images/Growatt-logo.png') }}"
                alt="Growatt Monitor Logo"
                class="h-16"
              />
            </div>
          </a>
          <nav aria-label="Primary Navigation">
            <ul class="flex items-center space-x-1">
              <li class="my-0">
                <a
                  href="/"
                  class="flex items-center font-medium text-sm py-2 px-3 rounded-md relative group {{ 'text-emerald-600 bg-emerald-50' if request.path == '/' else 'text-slate-700 hover:text-slate-900 hover:bg-slate-50' }}"
                  aria-current="{{ 'page' if request.path == '/' else 'false' }}"
                >
                  <i class="fas fa-tachometer-alt mr-1.5 text-sm"></i>
                  Dashboard {% if request.path == '/' %}
                  <span
                    class="absolute bottom-0 left-0 right-0 h-0.5 bg-emerald-500 rounded-full"
                  ></span>
                  {% endif %}
                </a>
              </li>
              <li class="my-0">
                <a
                  href="/plants"
                  class="flex items-center font-medium text-sm py-2 px-3 rounded-md relative group {{ 'text-emerald-600 bg-emerald-50' if request.path == '/plants' else 'text-slate-700 hover:text-slate-900 hover:bg-slate-50' }}"
                  aria-current="{{ 'page' if request.path == '/plants' else 'false' }}"
                >
                  <i class="fas fa-solar-panel mr-1.5 text-sm"></i>
                  Energy Plant {% if request.path == '/plants' %}
                  <span
                    class="absolute bottom-0 left-0 right-0 h-0.5 bg-emerald-500 rounded-full"
                  ></span>
                  {% endif %}
                </a>
              </li>
              <li class="my-0">
                <a
                  href="/devices"
                  class="flex items-center font-medium text-sm py-2 px-3 rounded-md relative group {{ 'text-emerald-600 bg-emerald-50' if request.path == '/devices' else 'text-slate-700 hover:text-slate-900 hover:bg-slate-50' }}"
                  aria-current="{{ 'page' if request.path == '/devices' else 'false' }}"
                >
                  <i class="fas fa-microchip mr-1.5 text-sm"></i>
                  Devices {% if request.path == '/devices' %}
                  <span
                    class="absolute bottom-0 left-0 right-0 h-0.5 bg-emerald-500 rounded-full"
                  ></span>
                  {% endif %}
                </a>
              </li>
              <li class="my-0">
                <a
                  href="/maps"
                  class="flex items-center font-medium text-sm py-2 px-3 rounded-md relative group {{ 'text-emerald-600 bg-emerald-50' if request.path == '/maps' else 'text-slate-700 hover:text-slate-900 hover:bg-slate-50' }}"
                  aria-current="{{ 'page' if request.path == '/maps' else 'false' }}"
                >
                  <i class="fas fa-map-marker-alt mr-1.5 text-sm"></i>
                  Maps {% if request.path == '/maps' %}
                  <span
                    class="absolute bottom-0 left-0 right-0 h-0.5 bg-emerald-500 rounded-full"
                  ></span>
                  {% endif %}
                </a>
              </li>
              <li class="my-0">
                <a
                  href="/analytics"
                  class="flex items-center font-medium text-sm py-2 px-3 rounded-md relative group {{ 'text-emerald-600 bg-emerald-50' if request.path == '/analytics' else 'text-slate-700 hover:text-slate-900 hover:bg-slate-50' }}"
                  aria-current="{{ 'page' if request.path == '/analytics' else 'false' }}"
                >
                  <i class="fas fa-chart-line mr-1.5 text-sm"></i>
                  Analytics {% if request.path == '/analytics' %}
                  <span
                    class="absolute bottom-0 left-0 right-0 h-0.5 bg-emerald-500 rounded-full"
                  ></span>
                  {% endif %}
                </a>
              </li>
              <li class="my-0">
                <a
                  href="/management"
                  class="flex items-center font-medium text-sm py-2 px-3 rounded-md relative group {{ 'text-emerald-600 bg-emerald-50' if request.path == '/analytics' else 'text-slate-700 hover:text-slate-900 hover:bg-slate-50' }}"
                  aria-current="{{ 'page' if request.path == '/management' else 'false' }}"
                >
                  <i class="fas fa-cogs mr-1.5 text-sm"></i>
                  Management {% if request.path == '/management' %}
                  <span
                    class="absolute bottom-0 left-0 right-0 h-0.5 bg-emerald-500 rounded-full"
                  ></span>
                  {% endif %}
                </a>
              </li>
            </ul>
          </nav>
        </div>

        <!-- Right side buttons -->
        <div class="flex items-center space-x-1">
          <div class="h-6 w-px bg-slate-200 mx-1"></div>

          {% if authenticated %}
          <div
            class="flex items-center gap-2 px-2 py-1.5 rounded-md hover:bg-slate-100 transition-colors"
          >
            <div
              class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600"
            >
              <i class="fas fa-user text-sm"></i>
            </div>
            <div class="flex flex-col items-start">
              <span class="text-sm font-medium text-slate-900">Admin</span>
              <span class="text-xs text-slate-500">Energy Manager</span>
            </div>
            <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
          </div>
          <button
            type="button"
            id="logout-button"
            class="ml-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-md shadow-sm flex items-center transition-all duration-200 hover:shadow-md active:scale-95"
            aria-label="Sign out of account"
          >
            <i class="fas fa-sign-out-alt mr-2 text-sm"></i>
            <span>Sign Out</span>
          </button>
          {% else %}
          <a
            href="/api/access"
            id="api-access-link"
            class="ml-2 bg-gradient-to-r from-green-500 to-green-600 text-white flex items-center gap-2 text-sm font-medium px-4 py-2 rounded-md shadow-sm hover:shadow-md active:scale-95 border border-green-400/40 transition-all duration-200 hover:-translate-y-0.5 hover:shadow-green-500/30 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50"
            data-method="get"
            aria-label="Get API access"
          >
            <i class="fas fa-key text-white/90 text-sm"></i>
            <span>Get Access</span>
          </a>
          {% endif %}
        </div>
      </div>

      <!-- Mobile menu (hidden by default) -->
      <div
        id="mobile-menu"
        class="hidden lg:hidden flex-col mt-3 space-y-0.5 opacity-0 max-h-0 overflow-hidden rounded-lg shadow-xl border border-gray-200 backdrop-blur-md transition-all duration-300"
        aria-labelledby="mobile-menu-button"
      >
        <div class="py-2 bg-white rounded-lg">
          <ul class="divide-y divide-gray-100">
            <li>
              <a
                href="/"
                class="flex items-center font-medium text-base py-2.5 px-4 text-{{ 'emerald-600' if request.path == '/' else 'slate-700 hover:text-slate-900 hover:bg-slate-50' }} transition-all"
                aria-current="{{ 'page' if request.path == '/' else 'false' }}"
              >
                <i
                  class="fas fa-tachometer-alt mr-3 w-5 text-center {{ 'text-emerald-600' if request.path == '/' else 'text-slate-600' }}"
                ></i>
                Dashboard
              </a>
            </li>
            <li>
              <a
                href="/plants"
                class="flex items-center font-medium text-base py-2.5 px-4 text-{{ 'emerald-600' if request.path == '/plants' else 'slate-700 hover:text-slate-900 hover:bg-slate-50' }} transition-all"
                aria-current="{{ 'page' if request.path == '/plants' else 'false' }}"
              >
                <i
                  class="fas fa-solar-panel mr-3 w-5 text-center {{ 'text-emerald-600' if request.path == '/plants' else 'text-slate-600' }}"
                ></i>
                Energy Production
              </a>
            </li>
            <li>
              <a
                href="/devices"
                class="flex items-center font-medium text-base py-2.5 px-4 text-{{ 'emerald-600' if request.path == '/devices' else 'slate-700 hover:text-slate-900 hover:bg-slate-50' }} transition-all"
                aria-current="{{ 'page' if request.path == '/devices' else 'false' }}"
              >
                <i
                  class="fas fa-microchip mr-3 w-5 text-center {{ 'text-emerald-600' if request.path == '/devices' else 'text-slate-600' }}"
                ></i>
                Devices
              </a>
            </li>
            <li>
              <a
                href="/maps"
                class="flex items-center font-medium text-base py-2.5 px-4 text-{{ 'emerald-600' if request.path == '/maps' else 'slate-700 hover:text-slate-900 hover:bg-slate-50' }} transition-all"
                aria-current="{{ 'page' if request.path == '/maps' else 'false' }}"
              >
                <i
                  class="fas fa-map-marker-alt mr-3 w-5 text-center {{ 'text-emerald-600' if request.path == '/maps' else 'text-slate-600' }}"
                ></i>
                Maps
              </a>
            </li>
            <li>
              <a
                href="/analytics"
                class="flex items-center font-medium text-base py-2.5 px-4 text-{{ 'emerald-600' if request.path == '/analytics' else 'slate-700 hover:text-slate-900 hover:bg-slate-50' }} transition-all"
                aria-current="{{ 'page' if request.path == '/analytics' else 'false' }}"
              >
                <i
                  class="fas fa-chart-line mr-3 w-5 text-center {{ 'text-emerald-600' if request.path == '/analytics' else 'text-slate-600' }}"
                ></i>
                Analytics
              </a>
            </li>
          </ul>

          <!-- Mobile System Metrics -->
          <div class="pt-2 mt-2 border-t border-slate-200 px-4">
            <div class="flex items-center justify-between py-2">
              <span class="text-sm font-medium text-slate-500"
                >System Metrics</span
              >
            </div>
            <div class="grid grid-cols-1 gap-2">
              <div
                class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200"
              >
                <span class="text-sm font-medium text-slate-700"
                  >Generation</span
                >
                <span
                  class="font-medium tabular-nums text-emerald-500"
                  id="mobile-generation-value"
                  >9.7 kWh</span
                >
              </div>
              <div
                class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200"
              >
                <span class="text-sm font-medium text-slate-700"
                  >Consumption</span
                >
                <span
                  class="font-medium tabular-nums text-blue-500"
                  id="mobile-consumption-value"
                  >6.4 kWh</span
                >
              </div>
              <div
                class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200"
              >
                <span class="text-sm font-medium text-slate-700"
                  >Efficiency</span
                >
                <span
                  class="font-medium tabular-nums text-amber-500"
                  id="mobile-efficiency-value"
                  >92.8%</span
                >
              </div>
            </div>
          </div>

          <!-- Mobile menu footer -->
          <div class="px-4 pt-3 mt-2 border-t border-slate-200">
            {% if not authenticated %}
            <a
              href="/api/access"
              id="mobile-api-access-link"
              class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white flex items-center justify-center gap-2 text-sm font-medium px-4 py-2.5 rounded-md shadow-sm mb-2"
            >
              <i class="fas fa-key text-white/90 text-sm"></i>
              Get Access
            </a>
            {% endif %} {% if authenticated %}
            <div class="flex items-center gap-2 py-2">
              <div
                class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600"
              >
                <i class="fas fa-user text-sm"></i>
              </div>
              <div class="flex flex-col">
                <span class="text-sm font-medium text-slate-900">Admin</span>
                <span class="text-xs text-slate-500">Energy Manager</span>
              </div>
            </div>
            <button
              type="button"
              id="mobile-logout-button"
              class="w-full mt-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-md shadow-sm flex items-center justify-center gap-2 transition-all duration-200"
            >
              <i class="fas fa-sign-out-alt text-sm"></i>
              Sign Out
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Energy data simulation
    let energyData = {
      generation: 9.72,
      consumption: 6.45,
      efficiency: 92.8,
    };

    // Update the date and time in the status bar
    function updateDateTime() {
      const now = new Date();

      // Format time
      const formattedTime =
        now.getHours().toString().padStart(2, "0") +
        ":" +
        now.getMinutes().toString().padStart(2, "0") +
        ":" +
        now.getSeconds().toString().padStart(2, "0");

      // Format date
      const options = { year: "numeric", month: "short", day: "numeric" };
      const formattedDate = now.toLocaleDateString(undefined, options);

      // Update DOM
      const timeElement = document.getElementById("current-time");
      const dateElement = document.getElementById("current-date");

      if (timeElement) timeElement.textContent = formattedTime;
      if (dateElement) dateElement.textContent = formattedDate;
    }

    // Update energy metrics
    function updateEnergyMetrics() {
      // Simulate changing energy data with small random variations
      energyData.generation = +(
        energyData.generation +
        (Math.random() * 0.02 - 0.01)
      ).toFixed(2);
      energyData.consumption = +(
        energyData.consumption +
        (Math.random() * 0.02 - 0.01)
      ).toFixed(2);
      energyData.efficiency = +(
        energyData.efficiency +
        (Math.random() * 0.2 - 0.1)
      ).toFixed(1);

      // Update desktop displays
      const genElement = document.getElementById("generation-value");
      const consElement = document.getElementById("consumption-value");
      const effElement = document.getElementById("efficiency-value");

      if (genElement) genElement.textContent = `${energyData.generation} kWh`;
      if (consElement)
        consElement.textContent = `${energyData.consumption} kWh`;
      if (effElement) effElement.textContent = `${energyData.efficiency}%`;

      // Update mobile displays
      const mobileGenElement = document.getElementById(
        "mobile-generation-value"
      );
      const mobileConsElement = document.getElementById(
        "mobile-consumption-value"
      );
      const mobileEffElement = document.getElementById(
        "mobile-efficiency-value"
      );

      if (mobileGenElement)
        mobileGenElement.textContent = `${energyData.generation} kWh`;
      if (mobileConsElement)
        mobileConsElement.textContent = `${energyData.consumption} kWh`;
      if (mobileEffElement)
        mobileEffElement.textContent = `${energyData.efficiency}%`;
    }

    // Mobile menu functionality
    const menuButton = document.getElementById("mobile-menu-button");
    const mobileMenu = document.getElementById("mobile-menu");
    const menuIconBars = document.getElementById("menu-icon-bars");
    const menuIconClose = document.getElementById("menu-icon-close");
    let isMenuOpen = false;

    function toggleMenu() {
      isMenuOpen = !isMenuOpen;
      menuButton.setAttribute("aria-expanded", isMenuOpen);

      // Toggle menu icons
      if (isMenuOpen) {
        menuIconBars.classList.add("hidden");
        menuIconClose.classList.remove("hidden");
      } else {
        menuIconBars.classList.remove("hidden");
        menuIconClose.classList.add("hidden");
      }

      // Toggle menu visibility
      if (isMenuOpen) {
        mobileMenu.classList.remove("hidden");
        setTimeout(() => {
          mobileMenu.classList.add("opacity-100");
          mobileMenu.style.maxHeight = `${mobileMenu.scrollHeight + 20}px`;
        }, 10);
      } else {
        mobileMenu.classList.remove("opacity-100");
        mobileMenu.style.maxHeight = "0";
        setTimeout(() => {
          mobileMenu.classList.add("hidden");
        }, 300);
      }
    }

    if (menuButton) {
      menuButton.addEventListener("click", toggleMenu);
    }

    // Set up logout functionality (reusing existing code)
    function handleLogout(event) {
      event.preventDefault();
      localStorage.clear();
      sessionStorage.clear();

      const clickedButton = event.currentTarget;
      const originalText = clickedButton.innerHTML;
      clickedButton.innerHTML =
        '<i class="fas fa-spinner fa-spin mr-1.5" aria-hidden="true"></i><span>Logging out...</span>';
      clickedButton.disabled = true;

      setTimeout(() => {
        window.location.href = "/api/logout";
      }, 300);
    }

    const logoutButton = document.getElementById("logout-button");
    const mobileLogoutButton = document.getElementById("mobile-logout-button");

    if (logoutButton) {
      logoutButton.addEventListener("click", handleLogout);
    }

    if (mobileLogoutButton) {
      mobileLogoutButton.addEventListener("click", handleLogout);
    }

    // Clone the event listener from the main API access link if it exists
    const mobileAccessLink = document.getElementById("mobile-api-access-link");
    if (mobileAccessLink) {
      const mainAccessLink = document.getElementById("api-access-link");
      if (mainAccessLink && mainAccessLink.onclick) {
        mobileAccessLink.onclick = mainAccessLink.onclick;
      }
    }

    // Scroll behavior for sticky header
    const header = document.getElementById("site-header");
    const mainNav = document.getElementById("main-nav");
    let lastScrollTop = 0;

    function handleScroll() {
      const scrollTop =
        window.pageYOffset || document.documentElement.scrollTop;

      if (scrollTop > 10) {
        header.classList.add("shadow-lg", "shadow-slate-900/5");
        mainNav.classList.add("py-2.5");
        mainNav.classList.remove("py-3");
      } else {
        header.classList.remove("shadow-lg", "shadow-slate-900/5");
        mainNav.classList.add("py-3");
        mainNav.classList.remove("py-2.5");
      }

      // Remove the translation logic that hides the header
      lastScrollTop = scrollTop;
    }

    // Initialize functions and set intervals
    updateDateTime();
    updateEnergyMetrics();
    setInterval(updateDateTime, 1000);
    setInterval(updateEnergyMetrics, 5000);

    // Resize handling
    let resizeTimeout;
    function handleResize() {
      if (window.innerWidth >= 1024) {
        // Reset mobile menu if we resize to desktop
        mobileMenu.classList.add("hidden");
        mobileMenu.style.maxHeight = "0";
        mobileMenu.classList.remove("opacity-100");
        isMenuOpen = false;
        menuButton.setAttribute("aria-expanded", "false");
        if (menuIconBars && menuIconClose) {
          menuIconBars.classList.remove("hidden");
          menuIconClose.classList.add("hidden");
        }
      }
    }

    window.addEventListener("resize", function () {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(handleResize, 100);
    });

    window.addEventListener("scroll", handleScroll);

    // Initial execution
    handleResize();
    handleScroll();
  });
</script>
