<header class="relative overflow-hidden shadow-sm">
  <div class="absolute inset-0 bg-pattern opacity-5 z-0"></div>
  <div
    class="py-1.5 border-b border-gray-700 relative z-10 bg-gradient-to-r from-slate-900 to-slate-800"
  >
    <div class="container mx-auto px-2 sm:px-4">
      <div class="flex justify-between items-center text-xs">
        <div class="flex items-center space-x-2 sm:space-x-4">
          <div class="flex items-center">
            <span
              class="pulse-dot pulse-success mr-2"
              aria-hidden="true"
            ></span>
            <span class="text-white font-medium tracking-wide"
              >System Online</span
            >
          </div>
          <div class="hidden sm:flex items-center">
            <i class="fas fa-clock text-white mr-1.5"></i>
            <span id="current-time" class="text-white"></span>
          </div>
        </div>
        <div class="flex items-center space-x-3 sm:space-x-4">
          <div class="hidden sm:flex items-center">
            <i class="fas fa-sun text-white mr-1.5"></i>
            <span class="text-gray-300 text-xs">Gen: </span>
            <span class="text-white font-medium ml-1">9.7 kWh</span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-bolt text-white mr-1.5"></i>
            <span class="text-gray-300 text-xs">Status: </span>
            <span class="text-green-300 font-bold font-medium ml-1"
              >Active</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>
  <nav
    class="px-2 sm:p-4 relative z-10 bg-gradient-to-b from-green-500 via-green-550 to-green-600 shadow-md border-b border-green-700"
    aria-label="Main navigation"
  >
    <div class="container mx-auto">
      <!-- Mobile menu button and logo -->
      <div class="flex items-center justify-between py-2 md:hidden">
        <a href="/" class="flex items-center" aria-label="Home">
          <img
            src="{{ url_for('static', filename='svg/logo.svg') }}"
            alt="Growatt Logo"
            class="h-6 sm:h-7 w-auto mr-2 text-white"
            onerror="this.src='{{ url_for('static', filename='favicon.ico') }}'; this.onerror=null;"
          />
        </a>
        <div class="flex items-center space-x-2 sm:space-x-3">
          <!-- Mobile menu button -->
          <button
            id="mobile-menu-button"
            class="text-charcoal focus:outline-none focus:ring-2 focus:ring-eco-green p-1.5 sm:p-2 rounded-md hover:bg-eco-green-10 transition-all duration-200 active:scale-95 hover:shadow-sm"
            aria-expanded="false"
            aria-controls="mobile-menu"
            aria-label="Toggle menu"
          >
            <svg
              class="w-5 h-5 sm:w-6 sm:h-6 transition-transform duration-300"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Desktop menu -->
      <div class="hidden md:flex items-center justify-between py-3 lg:py-4">
        <!-- Logo and main links -->
        <div class="flex items-center">
          <a
            href="/"
            class="flex items-center mr-4 md:mr-6 lg:mr-8 brand-logo transition-transform duration-300 hover:scale-105"
            aria-label="Home"
          >
            <div class="flex flex-col items-center">
              <img
                src="{{ url_for('static', filename='svg/logo.svg') }}"
                alt="Growatt Logo"
                class="h-8 md:h-9 w-auto"
                onerror="this.src='{{ url_for('static', filename='favicon.ico') }}'; this.onerror=null;"
              />
            </div>
          </a>
          <nav aria-label="Primary Navigation">
            <ul
              class="flex flex-wrap items-center space-x-1.5 md:space-x-2.5 lg:space-x-4"
            >
              <li class="my-1">
                <a
                  href="/"
                  class="nav-link text-charcoal text-xs md:text-sm lg:text-base font-medium hover:text-eco-green px-2.5 md:px-3 lg:px-4 py-2 md:py-2.5 rounded-md hover:bg-eco-green-10 transition-all duration-200 transform hover:-translate-y-0.5 {{ 'active-nav-link bg-eco-green-10 text-eco-green shadow-sm' if request.path == '/' }}"
                  aria-current="{{ 'page' if request.path == '/' else 'false' }}"
                >
                  <i
                    class="fas fa-tachometer-alt mr-2 text-eco-green"
                    aria-hidden="true"
                  ></i>
                  Dashboard
                </a>
              </li>
              <li class="my-1">
                <a
                  href="/plants"
                  class="nav-link text-charcoal text-xs md:text-sm lg:text-base font-medium hover:text-eco-green px-2.5 md:px-3 lg:px-4 py-2 md:py-2.5 rounded-md hover:bg-eco-green-10 transition-all duration-200 transform hover:-translate-y-0.5 {{ 'active-nav-link bg-eco-green-10 text-eco-green shadow-sm' if request.path == '/plants' }}"
                  aria-current="{{ 'page' if request.path == '/plants' else 'false' }}"
                >
                  <i
                    class="fas fa-solar-panel mr-2 text-eco-green"
                    aria-hidden="true"
                  ></i>
                  Plants
                </a>
              </li>
              <li class="my-1">
                <a
                  href="/maps"
                  class="nav-link text-charcoal text-xs md:text-sm lg:text-base font-medium hover:text-eco-green px-2.5 md:px-3 lg:px-4 py-2 md:py-2.5 rounded-md hover:bg-eco-green-10 transition-all duration-200 transform hover:-translate-y-0.5 {{ 'active-nav-link bg-eco-green-10 text-eco-green shadow-sm' if request.path == '/maps' }}"
                  aria-current="{{ 'page' if request.path == '/maps' else 'false' }}"
                >
                  <i
                    class="fas fa-map-marker-alt mr-2 text-eco-green"
                    aria-hidden="true"
                  ></i>
                  Maps
                </a>
              </li>
              <li class="my-1">
                <a
                  href="/devices"
                  class="nav-link text-charcoal text-xs md:text-sm lg:text-base font-medium hover:text-eco-green px-2.5 md:px-3 lg:px-4 py-2 md:py-2.5 rounded-md hover:bg-eco-green-10 transition-all duration-200 transform hover:-translate-y-0.5 {{ 'active-nav-link bg-eco-green-10 text-eco-green shadow-sm' if request.path == '/devices' }}"
                  aria-current="{{ 'page' if request.path == '/devices' else 'false' }}"
                >
                  <i
                    class="fas fa-microchip mr-2 text-eco-green"
                    aria-hidden="true"
                  ></i>
                  Devices
                </a>
              </li>
              <li class="my-1">
                <a
                  href="/weather"
                  class="nav-link text-charcoal text-xs md:text-sm lg:text-base font-medium hover:text-eco-green px-2.5 md:px-3 lg:px-4 py-2 md:py-2.5 rounded-md hover:bg-eco-green-10 transition-all duration-200 transform hover:-translate-y-0.5 {{ 'active-nav-link bg-eco-green-10 text-eco-green shadow-sm' if request.path == '/weather' }}"
                  aria-current="{{ 'page' if request.path == '/weather' else 'false' }}"
                >
                  <i
                    class="fas fa-cloud-sun mr-2 text-eco-green"
                    aria-hidden="true"
                  ></i>
                  Weather
                </a>
              </li>
              <li class="my-1 relative">
                <a
                  href="/analytics"
                  class="nav-link text-charcoal text-xs md:text-sm lg:text-base font-medium hover:text-eco-green px-2.5 md:px-3 lg:px-4 py-2 md:py-2.5 rounded-md hover:bg-eco-green-10 transition-all duration-200 transform hover:-translate-y-0.5 {{ 'active-nav-link bg-eco-green-10 text-eco-green shadow-sm' if request.path == '/analytics' }}"
                  aria-current="{{ 'page' if request.path == '/analytics' else 'false' }}"
                >
                  <i
                    class="fas fa-chart-line mr-2 text-eco-green"
                    aria-hidden="true"
                  ></i>
                  Analytics
                  <span
                    class="absolute -top-1.5 -right-1.5 bg-eco-green text-white text-xs px-1.5 py-0.5 rounded-full shadow-sm animate-pulse"
                    >New</span
                  >
                </a>
              </li>
            </ul>
          </nav>
        </div>

        <!-- Right side buttons -->
        <div class="flex items-center space-x-4 lg:space-x-6">
          {% if not authenticated %}
          <a
            href="/api/access"
            id="api-access-link"
            class="bg-gradient-to-r from-green-500 to-green-600 text-white flex items-center gap-2 text-sm sm:text-base px-4 py-2 rounded-md shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5 active:translate-y-0 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50"
            data-method="get"
          >
            <i class="fas fa-key text-green-100"></i>
            <span>Get Access</span>
          </a>
          {% endif %}

          <button
            type="button"
            id="logout-button"
            class="flex items-center justify-center text-slate-700 hover:text-red-600 text-sm lg:text-base font-medium px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition-all duration-200 active:scale-95 hover:bg-red-50 border border-transparent hover:border-red-200"
            aria-label="Sign out of account"
          >
            <i class="fas fa-sign-out-alt mr-2" aria-hidden="true"></i>
            <span class="sr-only sm:not-sr-only sm:inline-block">Sign Out</span>
          </button>
        </div>
      </div>

      <!-- Mobile menu (hidden by default) -->
      <div
        id="mobile-menu"
        class="hidden md:hidden flex-col mt-2 sm:mt-3 space-y-1 opacity-0 transition-all duration-300 ease-in-out max-h-0 overflow-hidden bg-white rounded-lg shadow-md border border-gray-100"
        aria-labelledby="mobile-menu-button"
      >
        <ul class="py-2 mobile-nav-links">
          <li>
            <a
              href="/"
              class="nav-link text-charcoal font-medium hover:text-eco-green py-3 sm:py-3.5 px-4 sm:px-5 hover:bg-eco-green-10 flex items-center transition-all duration-200 {{ 'active-nav-link bg-eco-green-5 border-l-4 border-eco-green' if request.path == '/' }}"
              aria-current="{{ 'page' if request.path == '/' else 'false' }}"
            >
              <i
                class="fas fa-home mr-3 sm:mr-4 w-5 text-center text-eco-green"
              ></i
              >Home
            </a>
          </li>
          <li>
            <a
              href="/plants"
              class="nav-link text-charcoal font-medium hover:text-eco-green py-3 sm:py-3.5 px-4 sm:px-5 hover:bg-eco-green-10 flex items-center transition-all duration-200 {{ 'active-nav-link bg-eco-green-5 border-l-4 border-eco-green' if request.path == '/plants' }}"
              aria-current="{{ 'page' if request.path == '/plants' else 'false' }}"
            >
              <i
                class="fas fa-solar-panel mr-3 sm:mr-4 w-5 text-center text-eco-green"
              ></i
              >Plants
            </a>
          </li>
          <li>
            <a
              href="/devices"
              class="nav-link text-charcoal font-medium hover:text-eco-green py-3 sm:py-3.5 px-4 sm:px-5 hover:bg-eco-green-10 flex items-center transition-all duration-200 {{ 'active-nav-link bg-eco-green-5 border-l-4 border-eco-green' if request.path == '/devices' }}"
              aria-current="{{ 'page' if request.path == '/devices' else 'false' }}"
            >
              <i
                class="fas fa-microchip mr-3 sm:mr-4 w-5 text-center text-eco-green"
              ></i
              >Status Devices
            </a>
          </li>
          <li>
            <a
              href="/weather"
              class="nav-link text-charcoal font-medium hover:text-eco-green py-3 sm:py-3.5 px-4 sm:px-5 hover:bg-eco-green-10 flex items-center transition-all duration-200 {{ 'active-nav-link bg-eco-green-5 border-l-4 border-eco-green' if request.path == '/weather' }}"
              aria-current="{{ 'page' if request.path == '/weather' else 'false' }}"
            >
              <i
                class="fas fa-cloud-sun mr-3 sm:mr-4 w-5 text-center text-sky-blue"
              ></i
              >Weather Status
            </a>
          </li>
          <li>
            <a
              href="/maps"
              class="nav-link text-charcoal font-medium hover:text-eco-green py-3 sm:py-3.5 px-4 sm:px-5 hover:bg-eco-green-10 flex items-center transition-all duration-200 {{ 'active-nav-link bg-eco-green-5 border-l-4 border-eco-green' if request.path == '/maps' }}"
              aria-current="{{ 'page' if request.path == '/maps' else 'false' }}"
              aria-label="Maps page"
            >
              <i
                class="fas fa-map-marker-alt mr-3 sm:mr-4 w-5 text-center text-sunshine-yellow"
                aria-hidden="true"
              ></i>
              <span>Maps</span>
            </a>
          </li>

          {% if not authenticated %}
          <li>
            <a
              href="/api/access"
              id="mobile-api-access-link"
              class="nav-link text-charcoal font-medium hover:text-eco-green py-3 sm:py-3.5 px-4 sm:px-5 hover:bg-eco-green-10 flex items-center transition-all duration-200"
              aria-label="Get API access"
              data-method="get"
            >
              <i
                class="fas fa-key mr-3 sm:mr-4 w-5 text-center text-ocean-teal"
                aria-hidden="true"
              ></i>
              <span>Get Access</span>
            </a>
          </li>
          {% endif %}

          <li
            class="border-t border-gray-100 my-1.5"
            role="separator"
            aria-hidden="true"
          ></li>

          <li>
            <button
              type="button"
              id="mobile-logout-button"
              class="w-full text-left text-charcoal font-medium hover:text-danger py-3 sm:py-3.5 px-4 sm:px-5 hover:bg-danger hover:bg-opacity-10 flex items-center transition-all duration-200"
              aria-label="Sign out of account"
            >
              <i
                class="fas fa-sign-out-alt mr-3 sm:mr-4 w-5 text-center text-danger"
                aria-hidden="true"
              ></i>
              <span>Sign Out</span>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Update the current time in the status bar
    function updateCurrentTime() {
      const timeElement = document.getElementById("current-time");
      if (timeElement) {
        const now = new Date();
        const formattedTime = now.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        timeElement.textContent = formattedTime;
      }
    }

    // Update time immediately and then every minute
    updateCurrentTime();
    setInterval(updateCurrentTime, 60000);

    // Cache DOM elements for better performance
    const menuButton = document.getElementById("mobile-menu-button");
    const mobileMenu = document.getElementById("mobile-menu");
    const mobileAccessLink = document.getElementById("mobile-api-access-link");
    const logoutButton = document.getElementById("logout-button");
    const mobileLogoutButton = document.getElementById("mobile-logout-button");
    let isMenuOpen = false;

    // Set up logout functionality
    function handleLogout(event) {
      // Prevent default button behavior
      event.preventDefault();

      // First clear any stored data/cache
      localStorage.clear();
      sessionStorage.clear();

      // Show feedback to user before redirect
      const clickedButton = event.currentTarget;
      const originalText = clickedButton.innerHTML;
      clickedButton.innerHTML =
        '<i class="fas fa-spinner fa-spin mr-1.5" aria-hidden="true"></i><span>Logging out...</span>';
      clickedButton.disabled = true;

      // Small timeout to ensure user sees feedback
      setTimeout(() => {
        // Then redirect to logout endpoint
        window.location.href = "/api/logout";
      }, 300);
    }

    // Add logout event listeners
    if (logoutButton) {
      logoutButton.addEventListener("click", handleLogout);
    }

    if (mobileLogoutButton) {
      mobileLogoutButton.addEventListener("click", handleLogout);
    }

    // Clone the event listener from the main API access link if it exists
    if (mobileAccessLink) {
      const mainAccessLink = document.getElementById("api-access-link");
      if (mainAccessLink && mainAccessLink.onclick) {
        mobileAccessLink.onclick = mainAccessLink.onclick;
      }
    }

    // Toggle mobile menu with improved animation
    menuButton.addEventListener("click", function () {
      isMenuOpen = !isMenuOpen;

      // Update ARIA attributes for accessibility
      menuButton.setAttribute("aria-expanded", isMenuOpen);

      // Animate menu button icon
      const menuIcon = menuButton.querySelector("svg");
      if (isMenuOpen) {
        menuIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />`;
        menuIcon.classList.add("transform", "rotate-0");
      } else {
        menuIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />`;
        menuIcon.classList.remove("transform", "rotate-0");
      }

      // Toggle visibility with improved animation
      if (isMenuOpen) {
        mobileMenu.classList.remove("hidden");

        // Use requestAnimationFrame for smoother transitions
        requestAnimationFrame(() => {
          mobileMenu.classList.remove("opacity-0");
          mobileMenu.classList.add("opacity-100");
          mobileMenu.style.maxHeight = `${mobileMenu.scrollHeight + 20}px`; // Add padding for safety
        });
      } else {
        mobileMenu.classList.remove("opacity-100");
        mobileMenu.classList.add("opacity-0");
        mobileMenu.style.maxHeight = "0";

        // Hide completely after animation completes
        setTimeout(function () {
          mobileMenu.classList.add("hidden");
        }, 300); // Match the duration in the CSS
      }
    });

    // Handle responsive design for window resize
    const handleResize = () => {
      if (window.innerWidth >= 768) {
        // Reset mobile menu if we resize to desktop
        mobileMenu.classList.add("hidden");
        mobileMenu.classList.remove("opacity-100");
        mobileMenu.classList.add("opacity-0");
        mobileMenu.style.maxHeight = "0";
        isMenuOpen = false;
        menuButton.classList.remove("rotate-90");
        menuButton.setAttribute("aria-expanded", "false");
      }
    };

    // Throttle resize event for better performance
    let resizeTimeout;
    window.addEventListener("resize", function () {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(handleResize, 100);
    });

    // Initial check
    handleResize();

    // Add touch feedback for mobile menu items with improved feedback
    const mobileMenuItems = mobileMenu.querySelectorAll("a, button");
    mobileMenuItems.forEach((item) => {
      item.addEventListener("touchstart", function () {
        this.classList.add("bg-eco-green-10", "scale-[0.98]");
      });
      item.addEventListener("touchend", function () {
        this.classList.remove("bg-eco-green-10", "scale-[0.98]");
      });
    });

    // Add scroll behavior to make navbar sticky and change appearance on scroll
    let lastScrollTop = 0;
    const header = document.querySelector("header");

    window.addEventListener("scroll", function () {
      let scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      if (scrollTop > 10) {
        header.classList.add("navbar-scrolled");
      } else {
        header.classList.remove("navbar-scrolled");
      }

      if (scrollTop > lastScrollTop && scrollTop > 150) {
        // Scrolling down & past threshold
        header.classList.add("navbar-hidden");
      } else {
        // Scrolling up or at top
        header.classList.remove("navbar-hidden");
      }

      lastScrollTop = scrollTop;
    });
  });
</script>
<style>
  /* Pulse animations and core functionality styles that can't be replaced with Tailwind */
  .pulse-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    position: relative;
    transform: translateZ(0); /* Performance optimization */
    will-change: box-shadow; /* Performance hint */
  }
  @media (min-width: 375px) {
    .pulse-dot {
      width: 10px;
      height: 10px;
    }
  }
  @media (min-width: 640px) {
    .pulse-dot {
      width: 12px;
      height: 12px;
    }
  }
  .pulse-success {
    background-color: var(--eco-green);
    box-shadow: 0 0 0 rgba(76, 175, 80, 0.4);
    animation: pulse-green 2s infinite cubic-bezier(0.66, 0, 0.33, 1);
  }
  .pulse-warning {
    background-color: var(--warning-yellow);
    box-shadow: 0 0 0 rgba(255, 193, 7, 0.4);
    animation: pulse-yellow 2s infinite cubic-bezier(0.66, 0, 0.33, 1);
  }
  .pulse-danger {
    background-color: var(--danger-red);
    box-shadow: 0 0 0 rgba(244, 67, 54, 0.4);
    animation: pulse-red 2s infinite cubic-bezier(0.66, 0, 0.33, 1);
  }

  /* Enhanced animations for status indicators */
  @keyframes pulse-green {
    0% {
      box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.85);
      transform: scale(1);
    }
    50% {
      box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
      transform: scale(1.1);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
      transform: scale(1);
    }
  }
  @keyframes pulse-yellow {
    0% {
      box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.85);
      transform: scale(1);
    }
    50% {
      box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
      transform: scale(1.1);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
      transform: scale(1);
    }
  }
  @keyframes pulse-red {
    0% {
      box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.85);
      transform: scale(1);
    }
    50% {
      box-shadow: 0 0 0 10px rgba(244, 67, 54, 0);
      transform: scale(1.1);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
      transform: scale(1);
    }
  }

  /* Mobile menu animation - enhanced for better visual effect */
  #mobile-menu {
    transition: opacity 0.3s ease, max-height 0.3s ease;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(0, 0, 0, 0.05);
    background: linear-gradient(to bottom, white, #f9fafb);
    border-radius: 0.5rem;
  }

  /* Navbar scroll behavior - improved with smoother transition */
  .navbar-scrolled {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    background: linear-gradient(
      to bottom,
      rgba(255, 255, 255, 0.98),
      rgba(249, 250, 251, 0.96)
    );
    transition: all 0.4s ease;
  }

  .navbar-hidden {
    transform: translateY(-100%);
    transition: transform 0.4s ease-in-out;
  }

  /* Active link styles with improved visual effects */
  .active-nav-link {
    position: relative;
    font-weight: 600;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }

  /* Enhanced transition effect for all links */
  .nav-link {
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .nav-link::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background-color: var(--eco-green);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateX(-50%);
    opacity: 0;
  }

  .nav-link:hover::after,
  .active-nav-link::after {
    width: 70%;
    opacity: 1;
  }

  /* Add a subtle glow effect to active menu items */
  .active-nav-link {
    position: relative;
  }

  .active-nav-link::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(
      circle at center,
      rgba(52, 211, 153, 0.15),
      transparent 70%
    );
    border-radius: 0.375rem;
    opacity: 0.7;
    z-index: -1;
  }
</style>
