{% extends "base.html" %} {% block title %}Plants - Growatt API{% endblock %} {%
block content %}
<div class="container mx-auto px-3 sm:px-4 md:px-6 py-3 sm:py-6 max-w-7xl">
  <div
    x-data="plantsApp()"
    x-init="init()"
    class="bg-gradient-mint rounded-xl shadow-md p-4 sm:p-6"
  >
    <div
      class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3"
    >
      <h1
        class="text-xl sm:text-2xl md:text-3xl font-bold text-deep-forest font-headings"
      >
        Plants
      </h1>
      <div class="flex items-center gap-3">
        <!-- View toggle buttons -->
        <div
          class="hidden sm:flex items-center bg-white rounded-lg p-1 shadow-sm border border-light-gray"
        >
          <button
            @click="viewMode = 'table'"
            class="px-3 py-1.5 rounded text-sm flex items-center gap-1.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-eco-green/50"
            :class="viewMode === 'table' ? 'bg-eco-green text-white font-medium shadow-sm transform scale-105' : 'text-slate-gray hover:bg-snow-white'"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 10h18M3 14h18M3 18h18M3 6h18"
              />
            </svg>
            <span>Table</span>
          </button>
          <button
            @click="viewMode = 'cards'"
            class="px-3 py-1.5 rounded text-sm flex items-center gap-1.5 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-eco-green/50"
            :class="viewMode === 'cards' ? 'bg-eco-green text-white font-medium shadow-sm transform scale-105' : 'text-slate-gray hover:bg-snow-white'"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
              />
            </svg>
            <span>Cards</span>
          </button>
        </div>
        <button
          id="refresh-button"
          class="bg-gradient-to-r from-green-500 to-green-600 text-white flex items-center gap-2 text-sm sm:text-base px-4 py-2 rounded-md shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5 active:translate-y-0 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50"
          @click="fetchPlants()"
          :disabled="isLoading"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            :class="{'animate-spin': isLoading}"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
          <span
            x-text="isLoading ? 'Loading...' : 'Refresh'"
            class="font-medium"
          ></span>
        </button>
      </div>
    </div>

    <!-- Search and filter toolbar (visible only when we have plants) -->
    <div x-show="!isLoading && plants.length > 0">
      {% include 'components/plants/search_filter.html' %}
    </div>

    <!-- Loading Spinner -->
    <div id="loading" x-show="isLoading">
      {% include 'components/plants/loading_spinner.html' %}
    </div>

    <!-- Error Message -->
    <div id="error-message" x-show="errorMessage">
      {% include 'components/plants/error_message.html' %}
    </div>

    <!-- Empty State -->
    <div x-show="!isLoading && plants.length === 0">
      {% include 'components/plants/empty_state.html' %}
    </div>

    <!-- Card view (optimized for mobile) -->
    <div
      x-show="!isLoading && plants.length > 0 && viewMode === 'cards'"
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
      x-transition
    >
      <template x-for="plant in paginatedPlants" :key="plant.id">
        {% include 'components/plants/plant_card.html' %}
      </template>
    </div>

    <!-- Table view -->
    <div
      x-show="!isLoading && plants.length > 0 && viewMode === 'table'"
      x-transition
    >
      {% include 'components/plants/plant_table.html' %}

      <!-- Table Pagination -->
      {% include 'components/common/pagination.html' %}
    </div>

    <!-- Card view pagination (appears at the bottom of card view) -->
    <div
      x-show="!isLoading && plants.length > 0 && viewMode === 'cards' && totalPages > 1"
    >
      {% include 'components/plants/card_pagination.html' %}
    </div>
  </div>
</div>

<style>
  /* Animation for the loading spinner */
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }

  /* Responsive card hover effect enhancement */
  @media (hover: hover) {
    .card:hover {
      transform: translateY(-5px);
    }
  }

  /* Improved card transitions */
  .card {
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  }

  /* Solar icon glow animation for active plants */
  .plant-active .card-icon {
    animation: pulse-green 2s infinite;
  }

  @keyframes pulse-green {
    0% {
      box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
    }
    70% {
      box-shadow: 0 0 0 8px rgba(76, 175, 80, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
    }
  }

  /* Status colors */
  .status-active {
    background-color: #d1fae5;
    color: #065f46;
  }

  .status-inactive {
    background-color: #f3f4f6;
    color: #4b5563;
  }

  .status-maintenance {
    background-color: #fef3c7;
    color: #92400e;
  }

  .status-error {
    background-color: #fee2e2;
    color: #b91c1c;
  }

  /* Better table responsiveness for small screens */
  @media (max-width: 640px) {
    table {
      font-size: 0.8rem;
    }

    th,
    td {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
  }
</style>

<script>
  function plantsApp() {
    return {
      plants: [],
      filteredPlants: [],
      isLoading: true,
      errorMessage: "",
      viewMode: window.innerWidth < 640 ? "cards" : "table", // Default to cards on mobile, table on larger screens
      searchQuery: "",
      statusFilter: "all",
      sortField: "plantName", // Default sort field
      sortAsc: true, // Default sort direction

      // Pagination
      currentPage: 1,
      pageSize: window.innerWidth < 640 ? 6 : 10, // Smaller page size on mobile

      // Computed property for page numbers
      get pageNumbers() {
        const totalPages = this.totalPages;
        const currentPage = this.currentPage;

        if (totalPages <= 5) {
          return Array.from({ length: totalPages }, (_, i) => i + 1);
        }

        if (currentPage <= 3) {
          return [1, 2, 3, 4, 5];
        }

        if (currentPage >= totalPages - 2) {
          return Array.from({ length: 5 }, (_, i) => totalPages - 4 + i);
        }

        return [
          currentPage - 2,
          currentPage - 1,
          currentPage,
          currentPage + 1,
          currentPage + 2,
        ];
      },

      // Computed property for total pages
      get totalPages() {
        return Math.ceil(this.filteredPlants.length / this.pageSize);
      },

      // Computed property for paginated plants
      get paginatedPlants() {
        const start = (this.currentPage - 1) * this.pageSize;
        const end = start + this.pageSize;
        return this.filteredPlants.slice(start, end);
      },

      // Lifecycle hooks - Initialize with responsive settings
      init() {
        // Responsive view mode toggle based on screen size
        window.addEventListener("resize", () => {
          // Update page size when screen size changes
          this.pageSize = window.innerWidth < 640 ? 6 : 10;

          // Reset to page 1 if the current page would be out of bounds after resize
          if (this.currentPage > this.totalPages && this.totalPages > 0) {
            this.currentPage = 1;
          }
        });

        this.fetchPlants();
      },

      fetchPlants() {
        this.isLoading = true;
        this.errorMessage = "";

        fetch("/api/plants")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            // Process the data
            this.plants = Array.isArray(data) ? data : [];
            this.filteredPlants = [...this.plants]; // Initialize filtered plants
            this.sortPlants(); // Apply initial sort
            console.log("Plants data:", this.plants);
          })
          .catch((error) => {
            console.error("Error fetching plants:", error);
            this.errorMessage = `Failed to load plants: ${error.message}`;
          })
          .finally(() => {
            this.isLoading = false;
          });
      },

      // Filter plants based on search and status filter
      filterPlants() {
        this.currentPage = 1; // Reset to first page when filtering

        // Filter by search query and status
        this.filteredPlants = this.plants.filter((plant) => {
          const matchesSearch =
            !this.searchQuery ||
            (plant.plantName &&
              plant.plantName
                .toLowerCase()
                .includes(this.searchQuery.toLowerCase())) ||
            (plant.id && plant.id.toString().includes(this.searchQuery));

          const matchesStatus =
            this.statusFilter === "all" ||
            (plant.status || "active") === this.statusFilter;

          return matchesSearch && matchesStatus;
        });

        // Apply current sorting
        this.sortPlants();
      },

      // Sort plants by field
      sortBy(field) {
        if (this.sortField === field) {
          this.sortAsc = !this.sortAsc;
        } else {
          this.sortField = field;
          this.sortAsc = true;
        }

        this.sortPlants();
      },

      // Apply sorting to filtered plants
      sortPlants() {
        const field = this.sortField;
        const direction = this.sortAsc ? 1 : -1;

        this.filteredPlants.sort((a, b) => {
          let aValue = a[field];
          let bValue = b[field];

          // Handle undefined values
          if (aValue === undefined) aValue = "";
          if (bValue === undefined) bValue = "";

          // Convert to appropriate types for comparison
          if (typeof aValue === "string") {
            return direction * aValue.localeCompare(bValue);
          } else {
            return direction * (aValue - bValue);
          }
        });
      },

      // Pagination methods
      prevPage() {
        if (this.currentPage > 1) {
          this.currentPage--;
        }
      },

      nextPage() {
        if (this.currentPage < this.totalPages) {
          this.currentPage++;
        }
      },

      goToPage(page) {
        this.currentPage = page;
      },

      formatTimezone(timezone) {
        if (timezone === undefined || timezone === null) return "N/A";

        // Convert timezone string to number
        const timezoneNum = parseInt(timezone);
        if (isNaN(timezoneNum)) return timezone;

        // Format timezone as UTC+X or UTC-X
        const sign = timezoneNum >= 0 ? "+" : "-";
        const absValue = Math.abs(timezoneNum);
        return `UTC${sign}${absValue}`;
      },

      // Format power value with unit
      formatPower(power) {
        if (power === undefined || power === null) return "N/A";
        return `${power} kW`;
      },

      // Format energy value with unit
      formatEnergy(energy) {
        if (energy === undefined || energy === null) return "N/A";
        return `${energy} kWh`;
      },

      // Get status text
      getStatusText(status) {
        const statusMap = {
          active: "Active",
          inactive: "Inactive",
          maintenance: "Maintenance",
          error: "Error",
        };
        return statusMap[status] || "Unknown";
      },

      // Get status CSS class
      getStatusClass(status) {
        const classMap = {
          active: "status-active",
          inactive: "status-inactive",
          maintenance: "status-maintenance",
          error: "status-error",
        };
        return classMap[status] || "status-inactive";
      },
    };
  }
</script>
{% endblock %}
