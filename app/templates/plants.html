{% extends "base.html" %} {% block title %}Plants - Growatt API{% endblock %} {%
block content %}
<div id="plants-app" class="container mx-auto px-4 py-6" x-data="plantsApp">
  <h1 class="text-xl font-medium mb-4">Plants</h1>

  <div id="loading" class="flex justify-center py-4" x-show="isLoading">
    <div class="spinner border-2 border-t-2 rounded-full w-8 h-8"></div>
  </div>

  <div
    id="error-message"
    class="bg-red-50 text-red-600 p-3 mb-3 rounded"
    x-show="errorMessage"
  >
    <div class="flex items-center">
      <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
        <path
          fill-rule="evenodd"
          d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
          clip-rule="evenodd"
        ></path>
      </svg>
      <span x-text="errorMessage"></span>
    </div>
    <button
      @click="errorMessage = ''"
      class="text-sm text-red-700 hover:text-red-800 mt-1 ml-7"
    >
      Dismiss
    </button>
  </div>

  <div
    x-show="!isLoading && plants.length === 0"
    class="p-4 text-center bg-gray-50 rounded"
  >
    <p class="text-gray-500">
      No plants found. Please check your connection or credentials.
    </p>
  </div>

  <div class="overflow-x-auto rounded" x-show="plants.length > 0">
    <div class="w-full overflow-x-auto">
      <table class="table">
        <thead>
          <tr>
            <th>Plant ID</th>
            <th>Plant Name</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="plant in plants" :key="plant.id">
            <tr class="row-hover">
              <td x-text="plant.id"></td>
              <td x-text="plant.plantName || 'Unnamed Plant'"></td>
              <td>
                <span
                  class="badge badge-soft badge-success text-xs"
                  x-text="plant.status || ''"
                ></span>
              </td>
              <td x-text="plant.createDate || '-'"></td>
              <td>
                <a
                  :href="`/plant/${plant.id}/devices`"
                  class="btn btn-circle btn-text btn-sm"
                  aria-label="View devices"
                >
                  <span class="icon-[tabler--device-laptop] size-5"></span>
                </a>
                <button
                  class="btn btn-circle btn-text btn-sm"
                  aria-label="Edit plant"
                >
                  <span class="icon-[tabler--pencil] size-5"></span>
                </button>
                <button
                  class="btn btn-circle btn-text btn-sm"
                  aria-label="More options"
                >
                  <span class="icon-[tabler--dots-vertical] size-5"></span>
                </button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  document.addEventListener("alpine:init", () => {
    Alpine.data("plantsApp", () => ({
      plants: [],
      isLoading: true,
      errorMessage: "",
      retryCount: 0,
      maxRetries: 3,

      init() {
        this.fetchPlants();
      },

      fetchPlants(forceRefresh = false) {
        this.isLoading = true;
        this.errorMessage = "";

        // Add cache mechanism with timestamp
        const cacheKey = "growatt_plants_data";
        const cacheExpiration = 5 * 60 * 1000; // 5 minutes

        if (!forceRefresh) {
          const cachedData = localStorage.getItem(cacheKey);
          if (cachedData) {
            try {
              const parsed = JSON.parse(cachedData);
              if (Date.now() - parsed.timestamp < cacheExpiration) {
                this.plants = parsed.data;
                this.isLoading = false;
                return;
              }
            } catch (err) {
              console.warn("Invalid cache data", err);
              // Continue with fetch if cache parsing fails
            }
          }
        }

        fetch("/api/plants")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((response) => {
            // Check if response contains an error
            if (response.length === 1 && response[0].error) {
              // Handle API error response
              const errorData = response[0];
              throw new Error(errorData.ui_message || errorData.error);
            }

            // Process data
            const data = Array.isArray(response)
              ? response
              : response.data
              ? response.data
              : response.plants
              ? response.plants
              : [];

            if (data.length === 0 && this.retryCount < this.maxRetries) {
              // Retry if no data returned
              this.retryCount++;
              setTimeout(() => this.fetchPlants(), 2000);
              return;
            }

            this.plants = data;

            // Cache the result with timestamp
            localStorage.setItem(
              cacheKey,
              JSON.stringify({
                timestamp: Date.now(),
                data: data,
              })
            );

            // Reset retry counter on success
            this.retryCount = 0;

            console.log("Plants data loaded:", data.length, "plants");
          })
          .catch((error) => {
            this.errorMessage = "Error loading plants: " + error.message;
            console.error("Error fetching plants:", error);

            // Retry on network errors
            if (
              error.message.includes("networkerror") &&
              this.retryCount < this.maxRetries
            ) {
              this.retryCount++;
              setTimeout(() => this.fetchPlants(), 2000);
            }
          })
          .finally(() => {
            this.isLoading = false;
          });
      },
    }));
  });
</script>
{% endblock %}
