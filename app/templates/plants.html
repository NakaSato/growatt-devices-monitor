{% extends "base.html" %} {% block title %}Plants - Growatt API{% endblock %} {%
block content %}
<div id="plants-app" class="container mx-auto px-4 py-6" x-data="plantsApp">
  <h1 class="text-xl font-medium mb-4">Plants</h1>

  <div id="loading" class="flex justify-center py-4" x-show="isLoading">
    <div class="spinner border-2 border-t-2 rounded-full w-8 h-8"></div>
  </div>

  <div
    id="error-message"
    class="bg-red-50 text-red-600 px-3 py-2 mb-3"
    x-show="errorMessage"
    x-text="errorMessage"
  ></div>

  <div class="overflow-x-auto rounded">
    <table id="plants-table" class="w-full">
      <thead>
        <tr>
          <th class="px-3 text-left font-medium">Plant ID</th>
          <th class="px-3 text-left font-medium">Plant Name</th>
          <th class="px-3 text-left font-medium">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr x-show="plants.length === 0 && !isLoading">
          <td colspan="3" class="py-3 px-3 text-center text-gray-500">
            No plants found
          </td>
        </tr>
        <template x-for="plant in plants" :key="plant.id">
          <tr class="border-t">
            <td class="py-2 px-3" x-text="plant.id"></td>
            <td class="py-2 px-3" x-text="plant.plantName"></td>
            <td class="py-2 px-3">
              <a
                :href="`/plant/${plant.id}/devices`"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm"
              >
                View Devices
              </a>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener("alpine:init", () => {
    Alpine.data("plantsApp", () => ({
      plants: [],
      isLoading: true,
      errorMessage: "",

      init() {
        this.fetchPlants();
      },

      fetchPlants() {
        this.isLoading = true;
        this.errorMessage = "";

        fetch("/api/plants")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((response) => {
            // Check if response contains an error
            if (response.length === 1 && response[0].error) {
              // Handle API error response
              const errorData = response[0];
              throw new Error(errorData.ui_message || errorData.error);
            }

            // Process data
            const data = Array.isArray(response)
              ? response
              : response.data
              ? response.data
              : response.plants
              ? response.plants
              : [];

            this.plants = data;
            console.log("Plants data:", data);
          })
          .catch((error) => {
            this.errorMessage = "Error loading plants: " + error.message;
            console.error("Error fetching plants:", error);
          })
          .finally(() => {
            this.isLoading = false;
          });
      },
    }));
  });
</script>
{% endblock %}
